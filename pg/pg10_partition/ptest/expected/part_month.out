------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------
--                             按月建分区 测试
------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------
-- 创建分区表
drop table if exists tb1 cascade;
NOTICE:  table "tb1" does not exist, skipping
create table tb1(c1 int, c2 date, c3 int) partition by range (c2);

-- 批量增加分区
select rds.add_range_partitions('public.tb1', '2019-03-01'::date, '1 month', 10);
 add_range_partitions 
----------------------
 
(1 row)


-- 验证分区
select relname, relnamespace::regnamespace::text, pg_get_expr(relpartbound, oid, true) vals
  from pg_class
 where relnamespace::regnamespace::text='public' and relname like 'tb1%' and relispartition=true
 order by relname;
   relname    | relnamespace |                       vals                       
--------------+--------------+--------------------------------------------------
 tb1_20190301 | public       | FOR VALUES FROM ('03-01-2019') TO ('04-01-2019')
 tb1_20190401 | public       | FOR VALUES FROM ('04-01-2019') TO ('05-01-2019')
 tb1_20190501 | public       | FOR VALUES FROM ('05-01-2019') TO ('06-01-2019')
 tb1_20190601 | public       | FOR VALUES FROM ('06-01-2019') TO ('07-01-2019')
 tb1_20190701 | public       | FOR VALUES FROM ('07-01-2019') TO ('08-01-2019')
 tb1_20190801 | public       | FOR VALUES FROM ('08-01-2019') TO ('09-01-2019')
 tb1_20190901 | public       | FOR VALUES FROM ('09-01-2019') TO ('10-01-2019')
 tb1_20191001 | public       | FOR VALUES FROM ('10-01-2019') TO ('11-01-2019')
 tb1_20191101 | public       | FOR VALUES FROM ('11-01-2019') TO ('12-01-2019')
 tb1_20191201 | public       | FOR VALUES FROM ('12-01-2019') TO ('01-01-2020')
(10 rows)


-- 插入数据
insert into public.tb1 values(1, '20190301'::date, 1);
insert into public.tb1 values(2, '20190402'::date, 2);
insert into public.tb1 values(3, '20190503'::date, 3);
insert into public.tb1 values(4, '20190604'::date, 4);
insert into public.tb1 values(5, '20190705'::date, 5);
insert into public.tb1 values(6, '20190806'::date, 6);
insert into public.tb1 values(7, '20190907'::date, 7);
insert into public.tb1 values(8, '20191008'::date, 8);
insert into public.tb1 values(9, '20191109'::date, 9);
insert into public.tb1 values(10, '20191210'::date, 10);

-- 验证数据
select * from public.tb1 order by c1;
 c1 |     c2     | c3 
----+------------+----
  1 | 03-01-2019 |  1
  2 | 04-02-2019 |  2
  3 | 05-03-2019 |  3
  4 | 06-04-2019 |  4
  5 | 07-05-2019 |  5
  6 | 08-06-2019 |  6
  7 | 09-07-2019 |  7
  8 | 10-08-2019 |  8
  9 | 11-09-2019 |  9
 10 | 12-10-2019 | 10
(10 rows)

select * from public.tb1_20190301 order by c1;
 c1 |     c2     | c3 
----+------------+----
  1 | 03-01-2019 |  1
(1 row)

select * from public.tb1_20190401 order by c1;
 c1 |     c2     | c3 
----+------------+----
  2 | 04-02-2019 |  2
(1 row)

select * from public.tb1_20190501 order by c1;
 c1 |     c2     | c3 
----+------------+----
  3 | 05-03-2019 |  3
(1 row)

select * from public.tb1_20190601 order by c1;
 c1 |     c2     | c3 
----+------------+----
  4 | 06-04-2019 |  4
(1 row)

select * from public.tb1_20190701 order by c1;
 c1 |     c2     | c3 
----+------------+----
  5 | 07-05-2019 |  5
(1 row)

select * from public.tb1_20190801 order by c1;
 c1 |     c2     | c3 
----+------------+----
  6 | 08-06-2019 |  6
(1 row)

select * from public.tb1_20190901 order by c1;
 c1 |     c2     | c3 
----+------------+----
  7 | 09-07-2019 |  7
(1 row)

select * from public.tb1_20191001 order by c1;
 c1 |     c2     | c3 
----+------------+----
  8 | 10-08-2019 |  8
(1 row)

select * from public.tb1_20191101 order by c1;
 c1 |     c2     | c3 
----+------------+----
  9 | 11-09-2019 |  9
(1 row)

select * from public.tb1_20191201 order by c1;
 c1 |     c2     | c3 
----+------------+----
 10 | 12-10-2019 | 10
(1 row)


-- 分区表添加索引（包含大小写、空格制表符）
select rds.create_idx_on_parted_table('public.TB1', 'idx_tb1', 'create INDEX 	%i on 	%t(c1)');
                                                    create_idx_on_parted_table                                                     
-----------------------------------------------------------------------------------------------------------------------------------
 ("select rds.func_create_idx_on_paritition('create INDEX        idx_tb1_16549 on        public.tb1_20190301(c1)','')",success,"")
 ("select rds.func_create_idx_on_paritition('create INDEX        idx_tb1_16552 on        public.tb1_20190401(c1)','')",success,"")
 ("select rds.func_create_idx_on_paritition('create INDEX        idx_tb1_16555 on        public.tb1_20190501(c1)','')",success,"")
 ("select rds.func_create_idx_on_paritition('create INDEX        idx_tb1_16558 on        public.tb1_20190601(c1)','')",success,"")
 ("select rds.func_create_idx_on_paritition('create INDEX        idx_tb1_16561 on        public.tb1_20190701(c1)','')",success,"")
 ("select rds.func_create_idx_on_paritition('create INDEX        idx_tb1_16564 on        public.tb1_20190801(c1)','')",success,"")
 ("select rds.func_create_idx_on_paritition('create INDEX        idx_tb1_16567 on        public.tb1_20190901(c1)','')",success,"")
 ("select rds.func_create_idx_on_paritition('create INDEX        idx_tb1_16570 on        public.tb1_20191001(c1)','')",success,"")
 ("select rds.func_create_idx_on_paritition('create INDEX        idx_tb1_16573 on        public.tb1_20191101(c1)','')",success,"")
 ("select rds.func_create_idx_on_paritition('create INDEX        idx_tb1_16576 on        public.tb1_20191201(c1)','')",success,"")
(10 rows)


-- 验证索引
select * from pg_indexes where schemaname='public' and tablename like 'tb1%' order by tablename, indexname;
 schemaname |  tablename   |   indexname   | tablespace |                          indexdef                           
------------+--------------+---------------+------------+-------------------------------------------------------------
 public     | tb1_20190301 | idx_tb1_16549 |            | CREATE INDEX idx_tb1_16549 ON tb1_20190301 USING btree (c1)
 public     | tb1_20190401 | idx_tb1_16552 |            | CREATE INDEX idx_tb1_16552 ON tb1_20190401 USING btree (c1)
 public     | tb1_20190501 | idx_tb1_16555 |            | CREATE INDEX idx_tb1_16555 ON tb1_20190501 USING btree (c1)
 public     | tb1_20190601 | idx_tb1_16558 |            | CREATE INDEX idx_tb1_16558 ON tb1_20190601 USING btree (c1)
 public     | tb1_20190701 | idx_tb1_16561 |            | CREATE INDEX idx_tb1_16561 ON tb1_20190701 USING btree (c1)
 public     | tb1_20190801 | idx_tb1_16564 |            | CREATE INDEX idx_tb1_16564 ON tb1_20190801 USING btree (c1)
 public     | tb1_20190901 | idx_tb1_16567 |            | CREATE INDEX idx_tb1_16567 ON tb1_20190901 USING btree (c1)
 public     | tb1_20191001 | idx_tb1_16570 |            | CREATE INDEX idx_tb1_16570 ON tb1_20191001 USING btree (c1)
 public     | tb1_20191101 | idx_tb1_16573 |            | CREATE INDEX idx_tb1_16573 ON tb1_20191101 USING btree (c1)
 public     | tb1_20191201 | idx_tb1_16576 |            | CREATE INDEX idx_tb1_16576 ON tb1_20191201 USING btree (c1)
(10 rows)

select * from rds.user_tab_part_indexes_def;
 tab_name | idx_name |            idx_sql             | is_pkey 
----------+----------+--------------------------------+---------
 tb1      | idx_tb1  | create index    %i on   %t(c1) | f
(1 row)


-- 分区表添加索引（语法错误）
select rds.create_idx_on_parted_table('public.tb1', 'idx_tb1_e', 'create1 index %i on %t(c1)');
                                                               create_idx_on_parted_table                                                                
---------------------------------------------------------------------------------------------------------------------------------------------------------
 ("select rds.func_create_idx_on_paritition('create1 index idx_tb1_e_16549 on public.tb1_20190301(c1)','')",error,"syntax error at or near ""create1""")
 ("select rds.func_create_idx_on_paritition('create1 index idx_tb1_e_16552 on public.tb1_20190401(c1)','')",error,"syntax error at or near ""create1""")
 ("select rds.func_create_idx_on_paritition('create1 index idx_tb1_e_16555 on public.tb1_20190501(c1)','')",error,"syntax error at or near ""create1""")
 ("select rds.func_create_idx_on_paritition('create1 index idx_tb1_e_16558 on public.tb1_20190601(c1)','')",error,"syntax error at or near ""create1""")
 ("select rds.func_create_idx_on_paritition('create1 index idx_tb1_e_16561 on public.tb1_20190701(c1)','')",error,"syntax error at or near ""create1""")
 ("select rds.func_create_idx_on_paritition('create1 index idx_tb1_e_16564 on public.tb1_20190801(c1)','')",error,"syntax error at or near ""create1""")
 ("select rds.func_create_idx_on_paritition('create1 index idx_tb1_e_16567 on public.tb1_20190901(c1)','')",error,"syntax error at or near ""create1""")
 ("select rds.func_create_idx_on_paritition('create1 index idx_tb1_e_16570 on public.tb1_20191001(c1)','')",error,"syntax error at or near ""create1""")
 ("select rds.func_create_idx_on_paritition('create1 index idx_tb1_e_16573 on public.tb1_20191101(c1)','')",error,"syntax error at or near ""create1""")
 ("select rds.func_create_idx_on_paritition('create1 index idx_tb1_e_16576 on public.tb1_20191201(c1)','')",error,"syntax error at or near ""create1""")
(10 rows)


-- 验证索引
select * from pg_indexes where schemaname='public' and tablename like 'tb1%' order by tablename, indexname;
 schemaname |  tablename   |   indexname   | tablespace |                          indexdef                           
------------+--------------+---------------+------------+-------------------------------------------------------------
 public     | tb1_20190301 | idx_tb1_16549 |            | CREATE INDEX idx_tb1_16549 ON tb1_20190301 USING btree (c1)
 public     | tb1_20190401 | idx_tb1_16552 |            | CREATE INDEX idx_tb1_16552 ON tb1_20190401 USING btree (c1)
 public     | tb1_20190501 | idx_tb1_16555 |            | CREATE INDEX idx_tb1_16555 ON tb1_20190501 USING btree (c1)
 public     | tb1_20190601 | idx_tb1_16558 |            | CREATE INDEX idx_tb1_16558 ON tb1_20190601 USING btree (c1)
 public     | tb1_20190701 | idx_tb1_16561 |            | CREATE INDEX idx_tb1_16561 ON tb1_20190701 USING btree (c1)
 public     | tb1_20190801 | idx_tb1_16564 |            | CREATE INDEX idx_tb1_16564 ON tb1_20190801 USING btree (c1)
 public     | tb1_20190901 | idx_tb1_16567 |            | CREATE INDEX idx_tb1_16567 ON tb1_20190901 USING btree (c1)
 public     | tb1_20191001 | idx_tb1_16570 |            | CREATE INDEX idx_tb1_16570 ON tb1_20191001 USING btree (c1)
 public     | tb1_20191101 | idx_tb1_16573 |            | CREATE INDEX idx_tb1_16573 ON tb1_20191101 USING btree (c1)
 public     | tb1_20191201 | idx_tb1_16576 |            | CREATE INDEX idx_tb1_16576 ON tb1_20191201 USING btree (c1)
(10 rows)

select * from rds.user_tab_part_indexes_def;
 tab_name | idx_name |            idx_sql             | is_pkey 
----------+----------+--------------------------------+---------
 tb1      | idx_tb1  | create index    %i on   %t(c1) | f
(1 row)


-- 分区表添加索引（索引名长度超34bytes）
select rds.create_idx_on_parted_table('public.tb1', 'idx_tb12345678901234567890123456789', 'create index %i on %t(c1)');
ERROR:  The length of index name could not be more than 34 bytes, table name: tb1 index name: idx_tb12345678901234567890123456789
CONTEXT:  PL/pgSQL function rds.create_idx_on_parted_table(regclass,character varying,text,boolean) line 34 at RAISE
select rds.create_idx_on_parted_table('public.tb1', 'idx_tb1234567890123456789012345678', 'create index %i on %t(c1)');
                                                           create_idx_on_parted_table                                                           
------------------------------------------------------------------------------------------------------------------------------------------------
 ("select rds.func_create_idx_on_paritition('create index idx_tb1234567890123456789012345678_16549 on public.tb1_20190301(c1)','')",success,"")
 ("select rds.func_create_idx_on_paritition('create index idx_tb1234567890123456789012345678_16552 on public.tb1_20190401(c1)','')",success,"")
 ("select rds.func_create_idx_on_paritition('create index idx_tb1234567890123456789012345678_16555 on public.tb1_20190501(c1)','')",success,"")
 ("select rds.func_create_idx_on_paritition('create index idx_tb1234567890123456789012345678_16558 on public.tb1_20190601(c1)','')",success,"")
 ("select rds.func_create_idx_on_paritition('create index idx_tb1234567890123456789012345678_16561 on public.tb1_20190701(c1)','')",success,"")
 ("select rds.func_create_idx_on_paritition('create index idx_tb1234567890123456789012345678_16564 on public.tb1_20190801(c1)','')",success,"")
 ("select rds.func_create_idx_on_paritition('create index idx_tb1234567890123456789012345678_16567 on public.tb1_20190901(c1)','')",success,"")
 ("select rds.func_create_idx_on_paritition('create index idx_tb1234567890123456789012345678_16570 on public.tb1_20191001(c1)','')",success,"")
 ("select rds.func_create_idx_on_paritition('create index idx_tb1234567890123456789012345678_16573 on public.tb1_20191101(c1)','')",success,"")
 ("select rds.func_create_idx_on_paritition('create index idx_tb1234567890123456789012345678_16576 on public.tb1_20191201(c1)','')",success,"")
(10 rows)


-- 验证索引
select * from pg_indexes where schemaname='public' and tablename like 'tb1%' order by tablename, indexname;
 schemaname |  tablename   |                indexname                 | tablespace |                                        indexdef                                        
------------+--------------+------------------------------------------+------------+----------------------------------------------------------------------------------------
 public     | tb1_20190301 | idx_tb1234567890123456789012345678_16549 |            | CREATE INDEX idx_tb1234567890123456789012345678_16549 ON tb1_20190301 USING btree (c1)
 public     | tb1_20190301 | idx_tb1_16549                            |            | CREATE INDEX idx_tb1_16549 ON tb1_20190301 USING btree (c1)
 public     | tb1_20190401 | idx_tb1234567890123456789012345678_16552 |            | CREATE INDEX idx_tb1234567890123456789012345678_16552 ON tb1_20190401 USING btree (c1)
 public     | tb1_20190401 | idx_tb1_16552                            |            | CREATE INDEX idx_tb1_16552 ON tb1_20190401 USING btree (c1)
 public     | tb1_20190501 | idx_tb1234567890123456789012345678_16555 |            | CREATE INDEX idx_tb1234567890123456789012345678_16555 ON tb1_20190501 USING btree (c1)
 public     | tb1_20190501 | idx_tb1_16555                            |            | CREATE INDEX idx_tb1_16555 ON tb1_20190501 USING btree (c1)
 public     | tb1_20190601 | idx_tb1234567890123456789012345678_16558 |            | CREATE INDEX idx_tb1234567890123456789012345678_16558 ON tb1_20190601 USING btree (c1)
 public     | tb1_20190601 | idx_tb1_16558                            |            | CREATE INDEX idx_tb1_16558 ON tb1_20190601 USING btree (c1)
 public     | tb1_20190701 | idx_tb1234567890123456789012345678_16561 |            | CREATE INDEX idx_tb1234567890123456789012345678_16561 ON tb1_20190701 USING btree (c1)
 public     | tb1_20190701 | idx_tb1_16561                            |            | CREATE INDEX idx_tb1_16561 ON tb1_20190701 USING btree (c1)
 public     | tb1_20190801 | idx_tb1234567890123456789012345678_16564 |            | CREATE INDEX idx_tb1234567890123456789012345678_16564 ON tb1_20190801 USING btree (c1)
 public     | tb1_20190801 | idx_tb1_16564                            |            | CREATE INDEX idx_tb1_16564 ON tb1_20190801 USING btree (c1)
 public     | tb1_20190901 | idx_tb1234567890123456789012345678_16567 |            | CREATE INDEX idx_tb1234567890123456789012345678_16567 ON tb1_20190901 USING btree (c1)
 public     | tb1_20190901 | idx_tb1_16567                            |            | CREATE INDEX idx_tb1_16567 ON tb1_20190901 USING btree (c1)
 public     | tb1_20191001 | idx_tb1234567890123456789012345678_16570 |            | CREATE INDEX idx_tb1234567890123456789012345678_16570 ON tb1_20191001 USING btree (c1)
 public     | tb1_20191001 | idx_tb1_16570                            |            | CREATE INDEX idx_tb1_16570 ON tb1_20191001 USING btree (c1)
 public     | tb1_20191101 | idx_tb1234567890123456789012345678_16573 |            | CREATE INDEX idx_tb1234567890123456789012345678_16573 ON tb1_20191101 USING btree (c1)
 public     | tb1_20191101 | idx_tb1_16573                            |            | CREATE INDEX idx_tb1_16573 ON tb1_20191101 USING btree (c1)
 public     | tb1_20191201 | idx_tb1234567890123456789012345678_16576 |            | CREATE INDEX idx_tb1234567890123456789012345678_16576 ON tb1_20191201 USING btree (c1)
 public     | tb1_20191201 | idx_tb1_16576                            |            | CREATE INDEX idx_tb1_16576 ON tb1_20191201 USING btree (c1)
(20 rows)

select * from rds.user_tab_part_indexes_def;
 tab_name |              idx_name              |            idx_sql             | is_pkey 
----------+------------------------------------+--------------------------------+---------
 tb1      | idx_tb1                            | create index    %i on   %t(c1) | f
 tb1      | idx_tb1234567890123456789012345678 | create index %i on %t(c1)      | f
(2 rows)


-- 分区表添加索引（主键）
select rds.create_idx_on_parted_table('public.tb1', 'pk_idx_tb1', 'create unique index %i on %t(c1)', true);
                                                                                                      create_idx_on_parted_table                                                                                                       
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 ("select rds.func_create_idx_on_paritition('create unique index pk_idx_tb1_16549 on public.tb1_20190301(c1)','alter table public.tb1_20190301 add constraint pk_idx_tb1_16549 primary key using index pk_idx_tb1_16549')",success,"")
 ("select rds.func_create_idx_on_paritition('create unique index pk_idx_tb1_16552 on public.tb1_20190401(c1)','alter table public.tb1_20190401 add constraint pk_idx_tb1_16552 primary key using index pk_idx_tb1_16552')",success,"")
 ("select rds.func_create_idx_on_paritition('create unique index pk_idx_tb1_16555 on public.tb1_20190501(c1)','alter table public.tb1_20190501 add constraint pk_idx_tb1_16555 primary key using index pk_idx_tb1_16555')",success,"")
 ("select rds.func_create_idx_on_paritition('create unique index pk_idx_tb1_16558 on public.tb1_20190601(c1)','alter table public.tb1_20190601 add constraint pk_idx_tb1_16558 primary key using index pk_idx_tb1_16558')",success,"")
 ("select rds.func_create_idx_on_paritition('create unique index pk_idx_tb1_16561 on public.tb1_20190701(c1)','alter table public.tb1_20190701 add constraint pk_idx_tb1_16561 primary key using index pk_idx_tb1_16561')",success,"")
 ("select rds.func_create_idx_on_paritition('create unique index pk_idx_tb1_16564 on public.tb1_20190801(c1)','alter table public.tb1_20190801 add constraint pk_idx_tb1_16564 primary key using index pk_idx_tb1_16564')",success,"")
 ("select rds.func_create_idx_on_paritition('create unique index pk_idx_tb1_16567 on public.tb1_20190901(c1)','alter table public.tb1_20190901 add constraint pk_idx_tb1_16567 primary key using index pk_idx_tb1_16567')",success,"")
 ("select rds.func_create_idx_on_paritition('create unique index pk_idx_tb1_16570 on public.tb1_20191001(c1)','alter table public.tb1_20191001 add constraint pk_idx_tb1_16570 primary key using index pk_idx_tb1_16570')",success,"")
 ("select rds.func_create_idx_on_paritition('create unique index pk_idx_tb1_16573 on public.tb1_20191101(c1)','alter table public.tb1_20191101 add constraint pk_idx_tb1_16573 primary key using index pk_idx_tb1_16573')",success,"")
 ("select rds.func_create_idx_on_paritition('create unique index pk_idx_tb1_16576 on public.tb1_20191201(c1)','alter table public.tb1_20191201 add constraint pk_idx_tb1_16576 primary key using index pk_idx_tb1_16576')",success,"")
(10 rows)


-- 验证索引、主键
select * from pg_indexes where schemaname='public' and tablename like 'tb1%' order by tablename, indexname;
 schemaname |  tablename   |                indexname                 | tablespace |                                        indexdef                                        
------------+--------------+------------------------------------------+------------+----------------------------------------------------------------------------------------
 public     | tb1_20190301 | idx_tb1234567890123456789012345678_16549 |            | CREATE INDEX idx_tb1234567890123456789012345678_16549 ON tb1_20190301 USING btree (c1)
 public     | tb1_20190301 | idx_tb1_16549                            |            | CREATE INDEX idx_tb1_16549 ON tb1_20190301 USING btree (c1)
 public     | tb1_20190301 | pk_idx_tb1_16549                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16549 ON tb1_20190301 USING btree (c1)
 public     | tb1_20190401 | idx_tb1234567890123456789012345678_16552 |            | CREATE INDEX idx_tb1234567890123456789012345678_16552 ON tb1_20190401 USING btree (c1)
 public     | tb1_20190401 | idx_tb1_16552                            |            | CREATE INDEX idx_tb1_16552 ON tb1_20190401 USING btree (c1)
 public     | tb1_20190401 | pk_idx_tb1_16552                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16552 ON tb1_20190401 USING btree (c1)
 public     | tb1_20190501 | idx_tb1234567890123456789012345678_16555 |            | CREATE INDEX idx_tb1234567890123456789012345678_16555 ON tb1_20190501 USING btree (c1)
 public     | tb1_20190501 | idx_tb1_16555                            |            | CREATE INDEX idx_tb1_16555 ON tb1_20190501 USING btree (c1)
 public     | tb1_20190501 | pk_idx_tb1_16555                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16555 ON tb1_20190501 USING btree (c1)
 public     | tb1_20190601 | idx_tb1234567890123456789012345678_16558 |            | CREATE INDEX idx_tb1234567890123456789012345678_16558 ON tb1_20190601 USING btree (c1)
 public     | tb1_20190601 | idx_tb1_16558                            |            | CREATE INDEX idx_tb1_16558 ON tb1_20190601 USING btree (c1)
 public     | tb1_20190601 | pk_idx_tb1_16558                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16558 ON tb1_20190601 USING btree (c1)
 public     | tb1_20190701 | idx_tb1234567890123456789012345678_16561 |            | CREATE INDEX idx_tb1234567890123456789012345678_16561 ON tb1_20190701 USING btree (c1)
 public     | tb1_20190701 | idx_tb1_16561                            |            | CREATE INDEX idx_tb1_16561 ON tb1_20190701 USING btree (c1)
 public     | tb1_20190701 | pk_idx_tb1_16561                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16561 ON tb1_20190701 USING btree (c1)
 public     | tb1_20190801 | idx_tb1234567890123456789012345678_16564 |            | CREATE INDEX idx_tb1234567890123456789012345678_16564 ON tb1_20190801 USING btree (c1)
 public     | tb1_20190801 | idx_tb1_16564                            |            | CREATE INDEX idx_tb1_16564 ON tb1_20190801 USING btree (c1)
 public     | tb1_20190801 | pk_idx_tb1_16564                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16564 ON tb1_20190801 USING btree (c1)
 public     | tb1_20190901 | idx_tb1234567890123456789012345678_16567 |            | CREATE INDEX idx_tb1234567890123456789012345678_16567 ON tb1_20190901 USING btree (c1)
 public     | tb1_20190901 | idx_tb1_16567                            |            | CREATE INDEX idx_tb1_16567 ON tb1_20190901 USING btree (c1)
 public     | tb1_20190901 | pk_idx_tb1_16567                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16567 ON tb1_20190901 USING btree (c1)
 public     | tb1_20191001 | idx_tb1234567890123456789012345678_16570 |            | CREATE INDEX idx_tb1234567890123456789012345678_16570 ON tb1_20191001 USING btree (c1)
 public     | tb1_20191001 | idx_tb1_16570                            |            | CREATE INDEX idx_tb1_16570 ON tb1_20191001 USING btree (c1)
 public     | tb1_20191001 | pk_idx_tb1_16570                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16570 ON tb1_20191001 USING btree (c1)
 public     | tb1_20191101 | idx_tb1234567890123456789012345678_16573 |            | CREATE INDEX idx_tb1234567890123456789012345678_16573 ON tb1_20191101 USING btree (c1)
 public     | tb1_20191101 | idx_tb1_16573                            |            | CREATE INDEX idx_tb1_16573 ON tb1_20191101 USING btree (c1)
 public     | tb1_20191101 | pk_idx_tb1_16573                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16573 ON tb1_20191101 USING btree (c1)
 public     | tb1_20191201 | idx_tb1234567890123456789012345678_16576 |            | CREATE INDEX idx_tb1234567890123456789012345678_16576 ON tb1_20191201 USING btree (c1)
 public     | tb1_20191201 | idx_tb1_16576                            |            | CREATE INDEX idx_tb1_16576 ON tb1_20191201 USING btree (c1)
 public     | tb1_20191201 | pk_idx_tb1_16576                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16576 ON tb1_20191201 USING btree (c1)
(30 rows)

select * from rds.user_tab_part_indexes_def;
 tab_name |              idx_name              |             idx_sql              | is_pkey 
----------+------------------------------------+----------------------------------+---------
 tb1      | idx_tb1                            | create index    %i on   %t(c1)   | f
 tb1      | idx_tb1234567890123456789012345678 | create index %i on %t(c1)        | f
 tb1      | pk_idx_tb1                         | create unique index %i on %t(c1) | t
(3 rows)

select * from pg_constraint where conname like 'pk_idx_tb1%' order by conname;
     conname      | connamespace | contype | condeferrable | condeferred | convalidated | conrelid | contypid | conindid | confrelid | confupdtype | confdeltype | confmatchtype | conislocal | coninhcount | connoinherit | conkey | confkey | conpfeqop | conppeqop | conffeqop | conexclop | conbin | consrc 
------------------+--------------+---------+---------------+-------------+--------------+----------+----------+----------+-----------+-------------+-------------+---------------+------------+-------------+--------------+--------+---------+-----------+-----------+-----------+-----------+--------+--------
 pk_idx_tb1_16549 |         2200 | p       | f             | f           | t            |    16549 |        0 |    16599 |         0 |             |             |               | t          |           0 | t            | {1}    |         |           |           |           |           |        | 
 pk_idx_tb1_16552 |         2200 | p       | f             | f           | t            |    16552 |        0 |    16601 |         0 |             |             |               | t          |           0 | t            | {1}    |         |           |           |           |           |        | 
 pk_idx_tb1_16555 |         2200 | p       | f             | f           | t            |    16555 |        0 |    16603 |         0 |             |             |               | t          |           0 | t            | {1}    |         |           |           |           |           |        | 
 pk_idx_tb1_16558 |         2200 | p       | f             | f           | t            |    16558 |        0 |    16605 |         0 |             |             |               | t          |           0 | t            | {1}    |         |           |           |           |           |        | 
 pk_idx_tb1_16561 |         2200 | p       | f             | f           | t            |    16561 |        0 |    16607 |         0 |             |             |               | t          |           0 | t            | {1}    |         |           |           |           |           |        | 
 pk_idx_tb1_16564 |         2200 | p       | f             | f           | t            |    16564 |        0 |    16609 |         0 |             |             |               | t          |           0 | t            | {1}    |         |           |           |           |           |        | 
 pk_idx_tb1_16567 |         2200 | p       | f             | f           | t            |    16567 |        0 |    16611 |         0 |             |             |               | t          |           0 | t            | {1}    |         |           |           |           |           |        | 
 pk_idx_tb1_16570 |         2200 | p       | f             | f           | t            |    16570 |        0 |    16613 |         0 |             |             |               | t          |           0 | t            | {1}    |         |           |           |           |           |        | 
 pk_idx_tb1_16573 |         2200 | p       | f             | f           | t            |    16573 |        0 |    16615 |         0 |             |             |               | t          |           0 | t            | {1}    |         |           |           |           |           |        | 
 pk_idx_tb1_16576 |         2200 | p       | f             | f           | t            |    16576 |        0 |    16617 |         0 |             |             |               | t          |           0 | t            | {1}    |         |           |           |           |           |        | 
(10 rows)


-- 分区单独添加索引
create index idx_tb1_test on public.tb1_20190501(c1);
ERROR:  Creating an index directly on a table partition is not allowed, please invoke create_idx_on_parted_table to do this.
CONTEXT:  PL/pgSQL function rds.func_ddl_command_start() line 75 at RAISE

-- 验证索引
select * from pg_indexes where schemaname='public' and tablename like 'tb1%' order by tablename, indexname;
 schemaname |  tablename   |                indexname                 | tablespace |                                        indexdef                                        
------------+--------------+------------------------------------------+------------+----------------------------------------------------------------------------------------
 public     | tb1_20190301 | idx_tb1234567890123456789012345678_16549 |            | CREATE INDEX idx_tb1234567890123456789012345678_16549 ON tb1_20190301 USING btree (c1)
 public     | tb1_20190301 | idx_tb1_16549                            |            | CREATE INDEX idx_tb1_16549 ON tb1_20190301 USING btree (c1)
 public     | tb1_20190301 | pk_idx_tb1_16549                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16549 ON tb1_20190301 USING btree (c1)
 public     | tb1_20190401 | idx_tb1234567890123456789012345678_16552 |            | CREATE INDEX idx_tb1234567890123456789012345678_16552 ON tb1_20190401 USING btree (c1)
 public     | tb1_20190401 | idx_tb1_16552                            |            | CREATE INDEX idx_tb1_16552 ON tb1_20190401 USING btree (c1)
 public     | tb1_20190401 | pk_idx_tb1_16552                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16552 ON tb1_20190401 USING btree (c1)
 public     | tb1_20190501 | idx_tb1234567890123456789012345678_16555 |            | CREATE INDEX idx_tb1234567890123456789012345678_16555 ON tb1_20190501 USING btree (c1)
 public     | tb1_20190501 | idx_tb1_16555                            |            | CREATE INDEX idx_tb1_16555 ON tb1_20190501 USING btree (c1)
 public     | tb1_20190501 | pk_idx_tb1_16555                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16555 ON tb1_20190501 USING btree (c1)
 public     | tb1_20190601 | idx_tb1234567890123456789012345678_16558 |            | CREATE INDEX idx_tb1234567890123456789012345678_16558 ON tb1_20190601 USING btree (c1)
 public     | tb1_20190601 | idx_tb1_16558                            |            | CREATE INDEX idx_tb1_16558 ON tb1_20190601 USING btree (c1)
 public     | tb1_20190601 | pk_idx_tb1_16558                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16558 ON tb1_20190601 USING btree (c1)
 public     | tb1_20190701 | idx_tb1234567890123456789012345678_16561 |            | CREATE INDEX idx_tb1234567890123456789012345678_16561 ON tb1_20190701 USING btree (c1)
 public     | tb1_20190701 | idx_tb1_16561                            |            | CREATE INDEX idx_tb1_16561 ON tb1_20190701 USING btree (c1)
 public     | tb1_20190701 | pk_idx_tb1_16561                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16561 ON tb1_20190701 USING btree (c1)
 public     | tb1_20190801 | idx_tb1234567890123456789012345678_16564 |            | CREATE INDEX idx_tb1234567890123456789012345678_16564 ON tb1_20190801 USING btree (c1)
 public     | tb1_20190801 | idx_tb1_16564                            |            | CREATE INDEX idx_tb1_16564 ON tb1_20190801 USING btree (c1)
 public     | tb1_20190801 | pk_idx_tb1_16564                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16564 ON tb1_20190801 USING btree (c1)
 public     | tb1_20190901 | idx_tb1234567890123456789012345678_16567 |            | CREATE INDEX idx_tb1234567890123456789012345678_16567 ON tb1_20190901 USING btree (c1)
 public     | tb1_20190901 | idx_tb1_16567                            |            | CREATE INDEX idx_tb1_16567 ON tb1_20190901 USING btree (c1)
 public     | tb1_20190901 | pk_idx_tb1_16567                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16567 ON tb1_20190901 USING btree (c1)
 public     | tb1_20191001 | idx_tb1234567890123456789012345678_16570 |            | CREATE INDEX idx_tb1234567890123456789012345678_16570 ON tb1_20191001 USING btree (c1)
 public     | tb1_20191001 | idx_tb1_16570                            |            | CREATE INDEX idx_tb1_16570 ON tb1_20191001 USING btree (c1)
 public     | tb1_20191001 | pk_idx_tb1_16570                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16570 ON tb1_20191001 USING btree (c1)
 public     | tb1_20191101 | idx_tb1234567890123456789012345678_16573 |            | CREATE INDEX idx_tb1234567890123456789012345678_16573 ON tb1_20191101 USING btree (c1)
 public     | tb1_20191101 | idx_tb1_16573                            |            | CREATE INDEX idx_tb1_16573 ON tb1_20191101 USING btree (c1)
 public     | tb1_20191101 | pk_idx_tb1_16573                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16573 ON tb1_20191101 USING btree (c1)
 public     | tb1_20191201 | idx_tb1234567890123456789012345678_16576 |            | CREATE INDEX idx_tb1234567890123456789012345678_16576 ON tb1_20191201 USING btree (c1)
 public     | tb1_20191201 | idx_tb1_16576                            |            | CREATE INDEX idx_tb1_16576 ON tb1_20191201 USING btree (c1)
 public     | tb1_20191201 | pk_idx_tb1_16576                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16576 ON tb1_20191201 USING btree (c1)
(30 rows)

select * from rds.user_tab_part_indexes_def;
 tab_name |              idx_name              |             idx_sql              | is_pkey 
----------+------------------------------------+----------------------------------+---------
 tb1      | idx_tb1                            | create index    %i on   %t(c1)   | f
 tb1      | idx_tb1234567890123456789012345678 | create index %i on %t(c1)        | f
 tb1      | pk_idx_tb1                         | create unique index %i on %t(c1) | t
(3 rows)


-- 新增分区补建索引
select rds.add_range_partitions('public.tb1', '2020-01-01'::date, '1 month', 3);
ERROR:  type "create_idx_on_parted_table" does not exist
LINE 1: SELECT create_idx_on_parted_table 'alter table ' || l_part_n...
               ^
QUERY:  SELECT create_idx_on_parted_table 'alter table ' || l_part_name || ' add constraint ' || l_idx_name || ' primary key using index ' || l_idx_name
CONTEXT:  PL/pgSQL function rds.func_ddl_command_end() line 63 at assignment
SQL statement "create table tb1_20200101 partition of tb1 for values from ('20200101') to ('20200201')"
PL/pgSQL function rds.add_range_partitions(regclass,date,character varying,integer) line 38 at EXECUTE

-- 验证分区
select relname, relnamespace::regnamespace::text, pg_get_expr(relpartbound, oid, true) vals
  from pg_class
 where relnamespace::regnamespace::text='public' and relname like 'tb1%' and relispartition=true
 order by relname;
   relname    | relnamespace |                       vals                       
--------------+--------------+--------------------------------------------------
 tb1_20190301 | public       | FOR VALUES FROM ('03-01-2019') TO ('04-01-2019')
 tb1_20190401 | public       | FOR VALUES FROM ('04-01-2019') TO ('05-01-2019')
 tb1_20190501 | public       | FOR VALUES FROM ('05-01-2019') TO ('06-01-2019')
 tb1_20190601 | public       | FOR VALUES FROM ('06-01-2019') TO ('07-01-2019')
 tb1_20190701 | public       | FOR VALUES FROM ('07-01-2019') TO ('08-01-2019')
 tb1_20190801 | public       | FOR VALUES FROM ('08-01-2019') TO ('09-01-2019')
 tb1_20190901 | public       | FOR VALUES FROM ('09-01-2019') TO ('10-01-2019')
 tb1_20191001 | public       | FOR VALUES FROM ('10-01-2019') TO ('11-01-2019')
 tb1_20191101 | public       | FOR VALUES FROM ('11-01-2019') TO ('12-01-2019')
 tb1_20191201 | public       | FOR VALUES FROM ('12-01-2019') TO ('01-01-2020')
(10 rows)


-- 验证索引
select * from pg_indexes where schemaname='public' and tablename like 'tb1%' order by tablename, indexname;
 schemaname |  tablename   |                indexname                 | tablespace |                                        indexdef                                        
------------+--------------+------------------------------------------+------------+----------------------------------------------------------------------------------------
 public     | tb1_20190301 | idx_tb1234567890123456789012345678_16549 |            | CREATE INDEX idx_tb1234567890123456789012345678_16549 ON tb1_20190301 USING btree (c1)
 public     | tb1_20190301 | idx_tb1_16549                            |            | CREATE INDEX idx_tb1_16549 ON tb1_20190301 USING btree (c1)
 public     | tb1_20190301 | pk_idx_tb1_16549                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16549 ON tb1_20190301 USING btree (c1)
 public     | tb1_20190401 | idx_tb1234567890123456789012345678_16552 |            | CREATE INDEX idx_tb1234567890123456789012345678_16552 ON tb1_20190401 USING btree (c1)
 public     | tb1_20190401 | idx_tb1_16552                            |            | CREATE INDEX idx_tb1_16552 ON tb1_20190401 USING btree (c1)
 public     | tb1_20190401 | pk_idx_tb1_16552                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16552 ON tb1_20190401 USING btree (c1)
 public     | tb1_20190501 | idx_tb1234567890123456789012345678_16555 |            | CREATE INDEX idx_tb1234567890123456789012345678_16555 ON tb1_20190501 USING btree (c1)
 public     | tb1_20190501 | idx_tb1_16555                            |            | CREATE INDEX idx_tb1_16555 ON tb1_20190501 USING btree (c1)
 public     | tb1_20190501 | pk_idx_tb1_16555                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16555 ON tb1_20190501 USING btree (c1)
 public     | tb1_20190601 | idx_tb1234567890123456789012345678_16558 |            | CREATE INDEX idx_tb1234567890123456789012345678_16558 ON tb1_20190601 USING btree (c1)
 public     | tb1_20190601 | idx_tb1_16558                            |            | CREATE INDEX idx_tb1_16558 ON tb1_20190601 USING btree (c1)
 public     | tb1_20190601 | pk_idx_tb1_16558                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16558 ON tb1_20190601 USING btree (c1)
 public     | tb1_20190701 | idx_tb1234567890123456789012345678_16561 |            | CREATE INDEX idx_tb1234567890123456789012345678_16561 ON tb1_20190701 USING btree (c1)
 public     | tb1_20190701 | idx_tb1_16561                            |            | CREATE INDEX idx_tb1_16561 ON tb1_20190701 USING btree (c1)
 public     | tb1_20190701 | pk_idx_tb1_16561                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16561 ON tb1_20190701 USING btree (c1)
 public     | tb1_20190801 | idx_tb1234567890123456789012345678_16564 |            | CREATE INDEX idx_tb1234567890123456789012345678_16564 ON tb1_20190801 USING btree (c1)
 public     | tb1_20190801 | idx_tb1_16564                            |            | CREATE INDEX idx_tb1_16564 ON tb1_20190801 USING btree (c1)
 public     | tb1_20190801 | pk_idx_tb1_16564                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16564 ON tb1_20190801 USING btree (c1)
 public     | tb1_20190901 | idx_tb1234567890123456789012345678_16567 |            | CREATE INDEX idx_tb1234567890123456789012345678_16567 ON tb1_20190901 USING btree (c1)
 public     | tb1_20190901 | idx_tb1_16567                            |            | CREATE INDEX idx_tb1_16567 ON tb1_20190901 USING btree (c1)
 public     | tb1_20190901 | pk_idx_tb1_16567                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16567 ON tb1_20190901 USING btree (c1)
 public     | tb1_20191001 | idx_tb1234567890123456789012345678_16570 |            | CREATE INDEX idx_tb1234567890123456789012345678_16570 ON tb1_20191001 USING btree (c1)
 public     | tb1_20191001 | idx_tb1_16570                            |            | CREATE INDEX idx_tb1_16570 ON tb1_20191001 USING btree (c1)
 public     | tb1_20191001 | pk_idx_tb1_16570                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16570 ON tb1_20191001 USING btree (c1)
 public     | tb1_20191101 | idx_tb1234567890123456789012345678_16573 |            | CREATE INDEX idx_tb1234567890123456789012345678_16573 ON tb1_20191101 USING btree (c1)
 public     | tb1_20191101 | idx_tb1_16573                            |            | CREATE INDEX idx_tb1_16573 ON tb1_20191101 USING btree (c1)
 public     | tb1_20191101 | pk_idx_tb1_16573                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16573 ON tb1_20191101 USING btree (c1)
 public     | tb1_20191201 | idx_tb1234567890123456789012345678_16576 |            | CREATE INDEX idx_tb1234567890123456789012345678_16576 ON tb1_20191201 USING btree (c1)
 public     | tb1_20191201 | idx_tb1_16576                            |            | CREATE INDEX idx_tb1_16576 ON tb1_20191201 USING btree (c1)
 public     | tb1_20191201 | pk_idx_tb1_16576                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16576 ON tb1_20191201 USING btree (c1)
(30 rows)

select * from rds.user_tab_part_indexes_def;
 tab_name |              idx_name              |             idx_sql              | is_pkey 
----------+------------------------------------+----------------------------------+---------
 tb1      | idx_tb1                            | create index    %i on   %t(c1)   | f
 tb1      | idx_tb1234567890123456789012345678 | create index %i on %t(c1)        | f
 tb1      | pk_idx_tb1                         | create unique index %i on %t(c1) | t
(3 rows)


-- 分区单独删除索引
drop index idx_tb1_16486;
ERROR:  index "idx_tb1_16486" does not exist

-- 验证索引
select * from pg_indexes where schemaname='public' and tablename like 'tb1%' order by tablename, indexname;
 schemaname |  tablename   |                indexname                 | tablespace |                                        indexdef                                        
------------+--------------+------------------------------------------+------------+----------------------------------------------------------------------------------------
 public     | tb1_20190301 | idx_tb1234567890123456789012345678_16549 |            | CREATE INDEX idx_tb1234567890123456789012345678_16549 ON tb1_20190301 USING btree (c1)
 public     | tb1_20190301 | idx_tb1_16549                            |            | CREATE INDEX idx_tb1_16549 ON tb1_20190301 USING btree (c1)
 public     | tb1_20190301 | pk_idx_tb1_16549                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16549 ON tb1_20190301 USING btree (c1)
 public     | tb1_20190401 | idx_tb1234567890123456789012345678_16552 |            | CREATE INDEX idx_tb1234567890123456789012345678_16552 ON tb1_20190401 USING btree (c1)
 public     | tb1_20190401 | idx_tb1_16552                            |            | CREATE INDEX idx_tb1_16552 ON tb1_20190401 USING btree (c1)
 public     | tb1_20190401 | pk_idx_tb1_16552                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16552 ON tb1_20190401 USING btree (c1)
 public     | tb1_20190501 | idx_tb1234567890123456789012345678_16555 |            | CREATE INDEX idx_tb1234567890123456789012345678_16555 ON tb1_20190501 USING btree (c1)
 public     | tb1_20190501 | idx_tb1_16555                            |            | CREATE INDEX idx_tb1_16555 ON tb1_20190501 USING btree (c1)
 public     | tb1_20190501 | pk_idx_tb1_16555                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16555 ON tb1_20190501 USING btree (c1)
 public     | tb1_20190601 | idx_tb1234567890123456789012345678_16558 |            | CREATE INDEX idx_tb1234567890123456789012345678_16558 ON tb1_20190601 USING btree (c1)
 public     | tb1_20190601 | idx_tb1_16558                            |            | CREATE INDEX idx_tb1_16558 ON tb1_20190601 USING btree (c1)
 public     | tb1_20190601 | pk_idx_tb1_16558                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16558 ON tb1_20190601 USING btree (c1)
 public     | tb1_20190701 | idx_tb1234567890123456789012345678_16561 |            | CREATE INDEX idx_tb1234567890123456789012345678_16561 ON tb1_20190701 USING btree (c1)
 public     | tb1_20190701 | idx_tb1_16561                            |            | CREATE INDEX idx_tb1_16561 ON tb1_20190701 USING btree (c1)
 public     | tb1_20190701 | pk_idx_tb1_16561                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16561 ON tb1_20190701 USING btree (c1)
 public     | tb1_20190801 | idx_tb1234567890123456789012345678_16564 |            | CREATE INDEX idx_tb1234567890123456789012345678_16564 ON tb1_20190801 USING btree (c1)
 public     | tb1_20190801 | idx_tb1_16564                            |            | CREATE INDEX idx_tb1_16564 ON tb1_20190801 USING btree (c1)
 public     | tb1_20190801 | pk_idx_tb1_16564                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16564 ON tb1_20190801 USING btree (c1)
 public     | tb1_20190901 | idx_tb1234567890123456789012345678_16567 |            | CREATE INDEX idx_tb1234567890123456789012345678_16567 ON tb1_20190901 USING btree (c1)
 public     | tb1_20190901 | idx_tb1_16567                            |            | CREATE INDEX idx_tb1_16567 ON tb1_20190901 USING btree (c1)
 public     | tb1_20190901 | pk_idx_tb1_16567                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16567 ON tb1_20190901 USING btree (c1)
 public     | tb1_20191001 | idx_tb1234567890123456789012345678_16570 |            | CREATE INDEX idx_tb1234567890123456789012345678_16570 ON tb1_20191001 USING btree (c1)
 public     | tb1_20191001 | idx_tb1_16570                            |            | CREATE INDEX idx_tb1_16570 ON tb1_20191001 USING btree (c1)
 public     | tb1_20191001 | pk_idx_tb1_16570                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16570 ON tb1_20191001 USING btree (c1)
 public     | tb1_20191101 | idx_tb1234567890123456789012345678_16573 |            | CREATE INDEX idx_tb1234567890123456789012345678_16573 ON tb1_20191101 USING btree (c1)
 public     | tb1_20191101 | idx_tb1_16573                            |            | CREATE INDEX idx_tb1_16573 ON tb1_20191101 USING btree (c1)
 public     | tb1_20191101 | pk_idx_tb1_16573                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16573 ON tb1_20191101 USING btree (c1)
 public     | tb1_20191201 | idx_tb1234567890123456789012345678_16576 |            | CREATE INDEX idx_tb1234567890123456789012345678_16576 ON tb1_20191201 USING btree (c1)
 public     | tb1_20191201 | idx_tb1_16576                            |            | CREATE INDEX idx_tb1_16576 ON tb1_20191201 USING btree (c1)
 public     | tb1_20191201 | pk_idx_tb1_16576                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16576 ON tb1_20191201 USING btree (c1)
(30 rows)

select * from rds.user_tab_part_indexes_def;
 tab_name |              idx_name              |             idx_sql              | is_pkey 
----------+------------------------------------+----------------------------------+---------
 tb1      | idx_tb1                            | create index    %i on   %t(c1)   | f
 tb1      | idx_tb1234567890123456789012345678 | create index %i on %t(c1)        | f
 tb1      | pk_idx_tb1                         | create unique index %i on %t(c1) | t
(3 rows)


-- 分区表删除索引
select rds.drop_idx_on_parted_table('public.tb1', 'idx_tb1');
 drop_idx_on_parted_table 
--------------------------
 
(1 row)


-- 验证索引
select * from pg_indexes where schemaname='public' and tablename like 'tb1%' order by tablename, indexname;
 schemaname |  tablename   |                indexname                 | tablespace |                                        indexdef                                        
------------+--------------+------------------------------------------+------------+----------------------------------------------------------------------------------------
 public     | tb1_20190301 | idx_tb1234567890123456789012345678_16549 |            | CREATE INDEX idx_tb1234567890123456789012345678_16549 ON tb1_20190301 USING btree (c1)
 public     | tb1_20190301 | pk_idx_tb1_16549                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16549 ON tb1_20190301 USING btree (c1)
 public     | tb1_20190401 | idx_tb1234567890123456789012345678_16552 |            | CREATE INDEX idx_tb1234567890123456789012345678_16552 ON tb1_20190401 USING btree (c1)
 public     | tb1_20190401 | pk_idx_tb1_16552                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16552 ON tb1_20190401 USING btree (c1)
 public     | tb1_20190501 | idx_tb1234567890123456789012345678_16555 |            | CREATE INDEX idx_tb1234567890123456789012345678_16555 ON tb1_20190501 USING btree (c1)
 public     | tb1_20190501 | pk_idx_tb1_16555                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16555 ON tb1_20190501 USING btree (c1)
 public     | tb1_20190601 | idx_tb1234567890123456789012345678_16558 |            | CREATE INDEX idx_tb1234567890123456789012345678_16558 ON tb1_20190601 USING btree (c1)
 public     | tb1_20190601 | pk_idx_tb1_16558                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16558 ON tb1_20190601 USING btree (c1)
 public     | tb1_20190701 | idx_tb1234567890123456789012345678_16561 |            | CREATE INDEX idx_tb1234567890123456789012345678_16561 ON tb1_20190701 USING btree (c1)
 public     | tb1_20190701 | pk_idx_tb1_16561                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16561 ON tb1_20190701 USING btree (c1)
 public     | tb1_20190801 | idx_tb1234567890123456789012345678_16564 |            | CREATE INDEX idx_tb1234567890123456789012345678_16564 ON tb1_20190801 USING btree (c1)
 public     | tb1_20190801 | pk_idx_tb1_16564                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16564 ON tb1_20190801 USING btree (c1)
 public     | tb1_20190901 | idx_tb1234567890123456789012345678_16567 |            | CREATE INDEX idx_tb1234567890123456789012345678_16567 ON tb1_20190901 USING btree (c1)
 public     | tb1_20190901 | pk_idx_tb1_16567                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16567 ON tb1_20190901 USING btree (c1)
 public     | tb1_20191001 | idx_tb1234567890123456789012345678_16570 |            | CREATE INDEX idx_tb1234567890123456789012345678_16570 ON tb1_20191001 USING btree (c1)
 public     | tb1_20191001 | pk_idx_tb1_16570                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16570 ON tb1_20191001 USING btree (c1)
 public     | tb1_20191101 | idx_tb1234567890123456789012345678_16573 |            | CREATE INDEX idx_tb1234567890123456789012345678_16573 ON tb1_20191101 USING btree (c1)
 public     | tb1_20191101 | pk_idx_tb1_16573                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16573 ON tb1_20191101 USING btree (c1)
 public     | tb1_20191201 | idx_tb1234567890123456789012345678_16576 |            | CREATE INDEX idx_tb1234567890123456789012345678_16576 ON tb1_20191201 USING btree (c1)
 public     | tb1_20191201 | pk_idx_tb1_16576                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16576 ON tb1_20191201 USING btree (c1)
(20 rows)

select * from rds.user_tab_part_indexes_def;
 tab_name |              idx_name              |             idx_sql              | is_pkey 
----------+------------------------------------+----------------------------------+---------
 tb1      | idx_tb1234567890123456789012345678 | create index %i on %t(c1)        | f
 tb1      | pk_idx_tb1                         | create unique index %i on %t(c1) | t
(2 rows)


-- 批量truncate分区
select rds.truncate_range_partitions('public.tb1', '20190301', '20190603');
 truncate_range_partitions 
---------------------------
 
(1 row)


-- 验证数据
select * from public.tb1 order by c1;
 c1 |     c2     | c3 
----+------------+----
  4 | 06-04-2019 |  4
  5 | 07-05-2019 |  5
  6 | 08-06-2019 |  6
  7 | 09-07-2019 |  7
  8 | 10-08-2019 |  8
  9 | 11-09-2019 |  9
 10 | 12-10-2019 | 10
(7 rows)


-- ddl下推到分区
select relname, reloptions from pg_class where relname like 'tb1%' order by relname;
   relname    | reloptions 
--------------+------------
 tb1          | 
 tb1_20190301 | 
 tb1_20190401 | 
 tb1_20190501 | 
 tb1_20190601 | 
 tb1_20190701 | 
 tb1_20190801 | 
 tb1_20190901 | 
 tb1_20191001 | 
 tb1_20191101 | 
 tb1_20191201 | 
(11 rows)

select rds.run_command_on_parted_table('public.tb1', 'alter table %t set(fillfactor = 90)');
                 run_command_on_parted_table                  
--------------------------------------------------------------
 ("alter table tb1_20190301 set(fillfactor = 90)",success,"")
 ("alter table tb1_20190601 set(fillfactor = 90)",success,"")
 ("alter table tb1_20190701 set(fillfactor = 90)",success,"")
 ("alter table tb1_20190801 set(fillfactor = 90)",success,"")
 ("alter table tb1_20190901 set(fillfactor = 90)",success,"")
 ("alter table tb1_20191001 set(fillfactor = 90)",success,"")
 ("alter table tb1_20191101 set(fillfactor = 90)",success,"")
 ("alter table tb1_20191201 set(fillfactor = 90)",success,"")
 ("alter table tb1_20190401 set(fillfactor = 90)",success,"")
 ("alter table tb1_20190501 set(fillfactor = 90)",success,"")
(10 rows)

select relname, reloptions from pg_class where relname like 'tb1%' order by relname;
   relname    |   reloptions    
--------------+-----------------
 tb1          | 
 tb1_20190301 | {fillfactor=90}
 tb1_20190401 | {fillfactor=90}
 tb1_20190501 | {fillfactor=90}
 tb1_20190601 | {fillfactor=90}
 tb1_20190701 | {fillfactor=90}
 tb1_20190801 | {fillfactor=90}
 tb1_20190901 | {fillfactor=90}
 tb1_20191001 | {fillfactor=90}
 tb1_20191101 | {fillfactor=90}
 tb1_20191201 | {fillfactor=90}
(11 rows)


-- 批量删除分区
select rds.drop_range_partitions('public.tb1', '20190301', '20190603');
 drop_range_partitions 
-----------------------
 
(1 row)


-- 验证分区
select relname, relnamespace::regnamespace::text, pg_get_expr(relpartbound, oid, true) vals
  from pg_class
 where relnamespace::regnamespace::text='public' and relname like 'tb1%' and relispartition=true
 order by relname;
   relname    | relnamespace |                       vals                       
--------------+--------------+--------------------------------------------------
 tb1_20190601 | public       | FOR VALUES FROM ('06-01-2019') TO ('07-01-2019')
 tb1_20190701 | public       | FOR VALUES FROM ('07-01-2019') TO ('08-01-2019')
 tb1_20190801 | public       | FOR VALUES FROM ('08-01-2019') TO ('09-01-2019')
 tb1_20190901 | public       | FOR VALUES FROM ('09-01-2019') TO ('10-01-2019')
 tb1_20191001 | public       | FOR VALUES FROM ('10-01-2019') TO ('11-01-2019')
 tb1_20191101 | public       | FOR VALUES FROM ('11-01-2019') TO ('12-01-2019')
 tb1_20191201 | public       | FOR VALUES FROM ('12-01-2019') TO ('01-01-2020')
(7 rows)


-- ddl带双引号
create table "tb2"(c1 int, c2 date, c3 int) partition by range (c2);
ERROR:  DDL statement can not contain double quotes.
CONTEXT:  PL/pgSQL function rds.func_ddl_command_start() line 45 at RAISE

-- 删除分区表
drop table if exists tb1 cascade;
