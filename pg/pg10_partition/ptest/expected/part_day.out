------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------
--                             按天建分区 测试
------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------
-- 创建分区表
drop table if exists tb1 cascade;
NOTICE:  table "tb1" does not exist, skipping
create table tb1(c1 int, c2 date, c3 int) partition by range (c2);

-- 批量增加分区
select rds.add_range_partitions('public.tb1', '2019-03-01'::date, '1 day', 10);
 add_range_partitions 
----------------------
 
(1 row)


-- 验证分区
select relname, relnamespace::regnamespace::text, pg_get_expr(relpartbound, oid, true) vals
  from pg_class
 where relnamespace::regnamespace::text='public' and relname like 'tb1%' and relispartition=true
 order by relname;
   relname    | relnamespace |                       vals                       
--------------+--------------+--------------------------------------------------
 tb1_20190301 | public       | FOR VALUES FROM ('03-01-2019') TO ('03-02-2019')
 tb1_20190302 | public       | FOR VALUES FROM ('03-02-2019') TO ('03-03-2019')
 tb1_20190303 | public       | FOR VALUES FROM ('03-03-2019') TO ('03-04-2019')
 tb1_20190304 | public       | FOR VALUES FROM ('03-04-2019') TO ('03-05-2019')
 tb1_20190305 | public       | FOR VALUES FROM ('03-05-2019') TO ('03-06-2019')
 tb1_20190306 | public       | FOR VALUES FROM ('03-06-2019') TO ('03-07-2019')
 tb1_20190307 | public       | FOR VALUES FROM ('03-07-2019') TO ('03-08-2019')
 tb1_20190308 | public       | FOR VALUES FROM ('03-08-2019') TO ('03-09-2019')
 tb1_20190309 | public       | FOR VALUES FROM ('03-09-2019') TO ('03-10-2019')
 tb1_20190310 | public       | FOR VALUES FROM ('03-10-2019') TO ('03-11-2019')
(10 rows)


-- 插入数据
insert into public.tb1 values(1, '20190301'::date, 1);
insert into public.tb1 values(2, '20190302'::date, 2);
insert into public.tb1 values(3, '20190303'::date, 3);
insert into public.tb1 values(4, '20190304'::date, 4);
insert into public.tb1 values(5, '20190305'::date, 5);
insert into public.tb1 values(6, '20190306'::date, 6);
insert into public.tb1 values(7, '20190307'::date, 7);
insert into public.tb1 values(8, '20190308'::date, 8);
insert into public.tb1 values(9, '20190309'::date, 9);
insert into public.tb1 values(10, '20190310'::date, 10);

-- 验证数据
select * from public.tb1 order by c1;
 c1 |     c2     | c3 
----+------------+----
  1 | 03-01-2019 |  1
  2 | 03-02-2019 |  2
  3 | 03-03-2019 |  3
  4 | 03-04-2019 |  4
  5 | 03-05-2019 |  5
  6 | 03-06-2019 |  6
  7 | 03-07-2019 |  7
  8 | 03-08-2019 |  8
  9 | 03-09-2019 |  9
 10 | 03-10-2019 | 10
(10 rows)

select * from public.tb1_20190301 order by c1;
 c1 |     c2     | c3 
----+------------+----
  1 | 03-01-2019 |  1
(1 row)

select * from public.tb1_20190302 order by c1;
 c1 |     c2     | c3 
----+------------+----
  2 | 03-02-2019 |  2
(1 row)

select * from public.tb1_20190303 order by c1;
 c1 |     c2     | c3 
----+------------+----
  3 | 03-03-2019 |  3
(1 row)

select * from public.tb1_20190304 order by c1;
 c1 |     c2     | c3 
----+------------+----
  4 | 03-04-2019 |  4
(1 row)

select * from public.tb1_20190305 order by c1;
 c1 |     c2     | c3 
----+------------+----
  5 | 03-05-2019 |  5
(1 row)

select * from public.tb1_20190306 order by c1;
 c1 |     c2     | c3 
----+------------+----
  6 | 03-06-2019 |  6
(1 row)

select * from public.tb1_20190307 order by c1;
 c1 |     c2     | c3 
----+------------+----
  7 | 03-07-2019 |  7
(1 row)

select * from public.tb1_20190308 order by c1;
 c1 |     c2     | c3 
----+------------+----
  8 | 03-08-2019 |  8
(1 row)

select * from public.tb1_20190309 order by c1;
 c1 |     c2     | c3 
----+------------+----
  9 | 03-09-2019 |  9
(1 row)

select * from public.tb1_20190310 order by c1;
 c1 |     c2     | c3 
----+------------+----
 10 | 03-10-2019 | 10
(1 row)


-- 分区表添加索引（包含大小写、空格制表符）
select rds.create_idx_on_parted_table('public.TB1', 'idx_tb1', 'create INDEX 	%i on 	%t(c1)');
                                                    create_idx_on_parted_table                                                     
-----------------------------------------------------------------------------------------------------------------------------------
 ("select rds.func_create_idx_on_paritition('create INDEX        idx_tb1_16465 on        public.tb1_20190301(c1)','')",success,"")
 ("select rds.func_create_idx_on_paritition('create INDEX        idx_tb1_16468 on        public.tb1_20190302(c1)','')",success,"")
 ("select rds.func_create_idx_on_paritition('create INDEX        idx_tb1_16471 on        public.tb1_20190303(c1)','')",success,"")
 ("select rds.func_create_idx_on_paritition('create INDEX        idx_tb1_16474 on        public.tb1_20190304(c1)','')",success,"")
 ("select rds.func_create_idx_on_paritition('create INDEX        idx_tb1_16477 on        public.tb1_20190305(c1)','')",success,"")
 ("select rds.func_create_idx_on_paritition('create INDEX        idx_tb1_16480 on        public.tb1_20190306(c1)','')",success,"")
 ("select rds.func_create_idx_on_paritition('create INDEX        idx_tb1_16483 on        public.tb1_20190307(c1)','')",success,"")
 ("select rds.func_create_idx_on_paritition('create INDEX        idx_tb1_16486 on        public.tb1_20190308(c1)','')",success,"")
 ("select rds.func_create_idx_on_paritition('create INDEX        idx_tb1_16489 on        public.tb1_20190309(c1)','')",success,"")
 ("select rds.func_create_idx_on_paritition('create INDEX        idx_tb1_16492 on        public.tb1_20190310(c1)','')",success,"")
(10 rows)


-- 验证索引
select * from pg_indexes where schemaname='public' and tablename like 'tb1%' order by tablename, indexname;
 schemaname |  tablename   |   indexname   | tablespace |                          indexdef                           
------------+--------------+---------------+------------+-------------------------------------------------------------
 public     | tb1_20190301 | idx_tb1_16465 |            | CREATE INDEX idx_tb1_16465 ON tb1_20190301 USING btree (c1)
 public     | tb1_20190302 | idx_tb1_16468 |            | CREATE INDEX idx_tb1_16468 ON tb1_20190302 USING btree (c1)
 public     | tb1_20190303 | idx_tb1_16471 |            | CREATE INDEX idx_tb1_16471 ON tb1_20190303 USING btree (c1)
 public     | tb1_20190304 | idx_tb1_16474 |            | CREATE INDEX idx_tb1_16474 ON tb1_20190304 USING btree (c1)
 public     | tb1_20190305 | idx_tb1_16477 |            | CREATE INDEX idx_tb1_16477 ON tb1_20190305 USING btree (c1)
 public     | tb1_20190306 | idx_tb1_16480 |            | CREATE INDEX idx_tb1_16480 ON tb1_20190306 USING btree (c1)
 public     | tb1_20190307 | idx_tb1_16483 |            | CREATE INDEX idx_tb1_16483 ON tb1_20190307 USING btree (c1)
 public     | tb1_20190308 | idx_tb1_16486 |            | CREATE INDEX idx_tb1_16486 ON tb1_20190308 USING btree (c1)
 public     | tb1_20190309 | idx_tb1_16489 |            | CREATE INDEX idx_tb1_16489 ON tb1_20190309 USING btree (c1)
 public     | tb1_20190310 | idx_tb1_16492 |            | CREATE INDEX idx_tb1_16492 ON tb1_20190310 USING btree (c1)
(10 rows)

select * from rds.user_tab_part_indexes_def;
 tab_name | idx_name |            idx_sql             | is_pkey 
----------+----------+--------------------------------+---------
 tb1      | idx_tb1  | create index    %i on   %t(c1) | f
(1 row)


-- 分区表添加索引（语法错误）
select rds.create_idx_on_parted_table('public.tb1', 'idx_tb1_e', 'create1 index %i on %t(c1)');
                                                               create_idx_on_parted_table                                                                
---------------------------------------------------------------------------------------------------------------------------------------------------------
 ("select rds.func_create_idx_on_paritition('create1 index idx_tb1_e_16465 on public.tb1_20190301(c1)','')",error,"syntax error at or near ""create1""")
 ("select rds.func_create_idx_on_paritition('create1 index idx_tb1_e_16468 on public.tb1_20190302(c1)','')",error,"syntax error at or near ""create1""")
 ("select rds.func_create_idx_on_paritition('create1 index idx_tb1_e_16471 on public.tb1_20190303(c1)','')",error,"syntax error at or near ""create1""")
 ("select rds.func_create_idx_on_paritition('create1 index idx_tb1_e_16474 on public.tb1_20190304(c1)','')",error,"syntax error at or near ""create1""")
 ("select rds.func_create_idx_on_paritition('create1 index idx_tb1_e_16477 on public.tb1_20190305(c1)','')",error,"syntax error at or near ""create1""")
 ("select rds.func_create_idx_on_paritition('create1 index idx_tb1_e_16480 on public.tb1_20190306(c1)','')",error,"syntax error at or near ""create1""")
 ("select rds.func_create_idx_on_paritition('create1 index idx_tb1_e_16483 on public.tb1_20190307(c1)','')",error,"syntax error at or near ""create1""")
 ("select rds.func_create_idx_on_paritition('create1 index idx_tb1_e_16486 on public.tb1_20190308(c1)','')",error,"syntax error at or near ""create1""")
 ("select rds.func_create_idx_on_paritition('create1 index idx_tb1_e_16489 on public.tb1_20190309(c1)','')",error,"syntax error at or near ""create1""")
 ("select rds.func_create_idx_on_paritition('create1 index idx_tb1_e_16492 on public.tb1_20190310(c1)','')",error,"syntax error at or near ""create1""")
(10 rows)


-- 验证索引
select * from pg_indexes where schemaname='public' and tablename like 'tb1%' order by tablename, indexname;
 schemaname |  tablename   |   indexname   | tablespace |                          indexdef                           
------------+--------------+---------------+------------+-------------------------------------------------------------
 public     | tb1_20190301 | idx_tb1_16465 |            | CREATE INDEX idx_tb1_16465 ON tb1_20190301 USING btree (c1)
 public     | tb1_20190302 | idx_tb1_16468 |            | CREATE INDEX idx_tb1_16468 ON tb1_20190302 USING btree (c1)
 public     | tb1_20190303 | idx_tb1_16471 |            | CREATE INDEX idx_tb1_16471 ON tb1_20190303 USING btree (c1)
 public     | tb1_20190304 | idx_tb1_16474 |            | CREATE INDEX idx_tb1_16474 ON tb1_20190304 USING btree (c1)
 public     | tb1_20190305 | idx_tb1_16477 |            | CREATE INDEX idx_tb1_16477 ON tb1_20190305 USING btree (c1)
 public     | tb1_20190306 | idx_tb1_16480 |            | CREATE INDEX idx_tb1_16480 ON tb1_20190306 USING btree (c1)
 public     | tb1_20190307 | idx_tb1_16483 |            | CREATE INDEX idx_tb1_16483 ON tb1_20190307 USING btree (c1)
 public     | tb1_20190308 | idx_tb1_16486 |            | CREATE INDEX idx_tb1_16486 ON tb1_20190308 USING btree (c1)
 public     | tb1_20190309 | idx_tb1_16489 |            | CREATE INDEX idx_tb1_16489 ON tb1_20190309 USING btree (c1)
 public     | tb1_20190310 | idx_tb1_16492 |            | CREATE INDEX idx_tb1_16492 ON tb1_20190310 USING btree (c1)
(10 rows)

select * from rds.user_tab_part_indexes_def;
 tab_name | idx_name |            idx_sql             | is_pkey 
----------+----------+--------------------------------+---------
 tb1      | idx_tb1  | create index    %i on   %t(c1) | f
(1 row)


-- 分区表添加索引（索引名长度超34bytes）
select rds.create_idx_on_parted_table('public.tb1', 'idx_tb12345678901234567890123456789', 'create index %i on %t(c1)');
ERROR:  The length of index name could not be more than 34 bytes, table name: tb1 index name: idx_tb12345678901234567890123456789
CONTEXT:  PL/pgSQL function rds.create_idx_on_parted_table(regclass,character varying,text,boolean) line 34 at RAISE
select rds.create_idx_on_parted_table('public.tb1', 'idx_tb1234567890123456789012345678', 'create index %i on %t(c1)');
                                                           create_idx_on_parted_table                                                           
------------------------------------------------------------------------------------------------------------------------------------------------
 ("select rds.func_create_idx_on_paritition('create index idx_tb1234567890123456789012345678_16465 on public.tb1_20190301(c1)','')",success,"")
 ("select rds.func_create_idx_on_paritition('create index idx_tb1234567890123456789012345678_16468 on public.tb1_20190302(c1)','')",success,"")
 ("select rds.func_create_idx_on_paritition('create index idx_tb1234567890123456789012345678_16471 on public.tb1_20190303(c1)','')",success,"")
 ("select rds.func_create_idx_on_paritition('create index idx_tb1234567890123456789012345678_16474 on public.tb1_20190304(c1)','')",success,"")
 ("select rds.func_create_idx_on_paritition('create index idx_tb1234567890123456789012345678_16477 on public.tb1_20190305(c1)','')",success,"")
 ("select rds.func_create_idx_on_paritition('create index idx_tb1234567890123456789012345678_16480 on public.tb1_20190306(c1)','')",success,"")
 ("select rds.func_create_idx_on_paritition('create index idx_tb1234567890123456789012345678_16483 on public.tb1_20190307(c1)','')",success,"")
 ("select rds.func_create_idx_on_paritition('create index idx_tb1234567890123456789012345678_16486 on public.tb1_20190308(c1)','')",success,"")
 ("select rds.func_create_idx_on_paritition('create index idx_tb1234567890123456789012345678_16489 on public.tb1_20190309(c1)','')",success,"")
 ("select rds.func_create_idx_on_paritition('create index idx_tb1234567890123456789012345678_16492 on public.tb1_20190310(c1)','')",success,"")
(10 rows)


-- 验证索引
select * from pg_indexes where schemaname='public' and tablename like 'tb1%' order by tablename, indexname;
 schemaname |  tablename   |                indexname                 | tablespace |                                        indexdef                                        
------------+--------------+------------------------------------------+------------+----------------------------------------------------------------------------------------
 public     | tb1_20190301 | idx_tb1234567890123456789012345678_16465 |            | CREATE INDEX idx_tb1234567890123456789012345678_16465 ON tb1_20190301 USING btree (c1)
 public     | tb1_20190301 | idx_tb1_16465                            |            | CREATE INDEX idx_tb1_16465 ON tb1_20190301 USING btree (c1)
 public     | tb1_20190302 | idx_tb1234567890123456789012345678_16468 |            | CREATE INDEX idx_tb1234567890123456789012345678_16468 ON tb1_20190302 USING btree (c1)
 public     | tb1_20190302 | idx_tb1_16468                            |            | CREATE INDEX idx_tb1_16468 ON tb1_20190302 USING btree (c1)
 public     | tb1_20190303 | idx_tb1234567890123456789012345678_16471 |            | CREATE INDEX idx_tb1234567890123456789012345678_16471 ON tb1_20190303 USING btree (c1)
 public     | tb1_20190303 | idx_tb1_16471                            |            | CREATE INDEX idx_tb1_16471 ON tb1_20190303 USING btree (c1)
 public     | tb1_20190304 | idx_tb1234567890123456789012345678_16474 |            | CREATE INDEX idx_tb1234567890123456789012345678_16474 ON tb1_20190304 USING btree (c1)
 public     | tb1_20190304 | idx_tb1_16474                            |            | CREATE INDEX idx_tb1_16474 ON tb1_20190304 USING btree (c1)
 public     | tb1_20190305 | idx_tb1234567890123456789012345678_16477 |            | CREATE INDEX idx_tb1234567890123456789012345678_16477 ON tb1_20190305 USING btree (c1)
 public     | tb1_20190305 | idx_tb1_16477                            |            | CREATE INDEX idx_tb1_16477 ON tb1_20190305 USING btree (c1)
 public     | tb1_20190306 | idx_tb1234567890123456789012345678_16480 |            | CREATE INDEX idx_tb1234567890123456789012345678_16480 ON tb1_20190306 USING btree (c1)
 public     | tb1_20190306 | idx_tb1_16480                            |            | CREATE INDEX idx_tb1_16480 ON tb1_20190306 USING btree (c1)
 public     | tb1_20190307 | idx_tb1234567890123456789012345678_16483 |            | CREATE INDEX idx_tb1234567890123456789012345678_16483 ON tb1_20190307 USING btree (c1)
 public     | tb1_20190307 | idx_tb1_16483                            |            | CREATE INDEX idx_tb1_16483 ON tb1_20190307 USING btree (c1)
 public     | tb1_20190308 | idx_tb1234567890123456789012345678_16486 |            | CREATE INDEX idx_tb1234567890123456789012345678_16486 ON tb1_20190308 USING btree (c1)
 public     | tb1_20190308 | idx_tb1_16486                            |            | CREATE INDEX idx_tb1_16486 ON tb1_20190308 USING btree (c1)
 public     | tb1_20190309 | idx_tb1234567890123456789012345678_16489 |            | CREATE INDEX idx_tb1234567890123456789012345678_16489 ON tb1_20190309 USING btree (c1)
 public     | tb1_20190309 | idx_tb1_16489                            |            | CREATE INDEX idx_tb1_16489 ON tb1_20190309 USING btree (c1)
 public     | tb1_20190310 | idx_tb1234567890123456789012345678_16492 |            | CREATE INDEX idx_tb1234567890123456789012345678_16492 ON tb1_20190310 USING btree (c1)
 public     | tb1_20190310 | idx_tb1_16492                            |            | CREATE INDEX idx_tb1_16492 ON tb1_20190310 USING btree (c1)
(20 rows)

select * from rds.user_tab_part_indexes_def;
 tab_name |              idx_name              |            idx_sql             | is_pkey 
----------+------------------------------------+--------------------------------+---------
 tb1      | idx_tb1                            | create index    %i on   %t(c1) | f
 tb1      | idx_tb1234567890123456789012345678 | create index %i on %t(c1)      | f
(2 rows)


-- 分区表添加索引（主键）
select rds.create_idx_on_parted_table('public.tb1', 'pk_idx_tb1', 'create unique index %i on %t(c1)', true);
                                                                                                      create_idx_on_parted_table                                                                                                       
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 ("select rds.func_create_idx_on_paritition('create unique index pk_idx_tb1_16465 on public.tb1_20190301(c1)','alter table public.tb1_20190301 add constraint pk_idx_tb1_16465 primary key using index pk_idx_tb1_16465')",success,"")
 ("select rds.func_create_idx_on_paritition('create unique index pk_idx_tb1_16468 on public.tb1_20190302(c1)','alter table public.tb1_20190302 add constraint pk_idx_tb1_16468 primary key using index pk_idx_tb1_16468')",success,"")
 ("select rds.func_create_idx_on_paritition('create unique index pk_idx_tb1_16471 on public.tb1_20190303(c1)','alter table public.tb1_20190303 add constraint pk_idx_tb1_16471 primary key using index pk_idx_tb1_16471')",success,"")
 ("select rds.func_create_idx_on_paritition('create unique index pk_idx_tb1_16474 on public.tb1_20190304(c1)','alter table public.tb1_20190304 add constraint pk_idx_tb1_16474 primary key using index pk_idx_tb1_16474')",success,"")
 ("select rds.func_create_idx_on_paritition('create unique index pk_idx_tb1_16477 on public.tb1_20190305(c1)','alter table public.tb1_20190305 add constraint pk_idx_tb1_16477 primary key using index pk_idx_tb1_16477')",success,"")
 ("select rds.func_create_idx_on_paritition('create unique index pk_idx_tb1_16480 on public.tb1_20190306(c1)','alter table public.tb1_20190306 add constraint pk_idx_tb1_16480 primary key using index pk_idx_tb1_16480')",success,"")
 ("select rds.func_create_idx_on_paritition('create unique index pk_idx_tb1_16483 on public.tb1_20190307(c1)','alter table public.tb1_20190307 add constraint pk_idx_tb1_16483 primary key using index pk_idx_tb1_16483')",success,"")
 ("select rds.func_create_idx_on_paritition('create unique index pk_idx_tb1_16486 on public.tb1_20190308(c1)','alter table public.tb1_20190308 add constraint pk_idx_tb1_16486 primary key using index pk_idx_tb1_16486')",success,"")
 ("select rds.func_create_idx_on_paritition('create unique index pk_idx_tb1_16489 on public.tb1_20190309(c1)','alter table public.tb1_20190309 add constraint pk_idx_tb1_16489 primary key using index pk_idx_tb1_16489')",success,"")
 ("select rds.func_create_idx_on_paritition('create unique index pk_idx_tb1_16492 on public.tb1_20190310(c1)','alter table public.tb1_20190310 add constraint pk_idx_tb1_16492 primary key using index pk_idx_tb1_16492')",success,"")
(10 rows)


-- 验证索引、主键
select * from pg_indexes where schemaname='public' and tablename like 'tb1%' order by tablename, indexname;
 schemaname |  tablename   |                indexname                 | tablespace |                                        indexdef                                        
------------+--------------+------------------------------------------+------------+----------------------------------------------------------------------------------------
 public     | tb1_20190301 | idx_tb1234567890123456789012345678_16465 |            | CREATE INDEX idx_tb1234567890123456789012345678_16465 ON tb1_20190301 USING btree (c1)
 public     | tb1_20190301 | idx_tb1_16465                            |            | CREATE INDEX idx_tb1_16465 ON tb1_20190301 USING btree (c1)
 public     | tb1_20190301 | pk_idx_tb1_16465                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16465 ON tb1_20190301 USING btree (c1)
 public     | tb1_20190302 | idx_tb1234567890123456789012345678_16468 |            | CREATE INDEX idx_tb1234567890123456789012345678_16468 ON tb1_20190302 USING btree (c1)
 public     | tb1_20190302 | idx_tb1_16468                            |            | CREATE INDEX idx_tb1_16468 ON tb1_20190302 USING btree (c1)
 public     | tb1_20190302 | pk_idx_tb1_16468                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16468 ON tb1_20190302 USING btree (c1)
 public     | tb1_20190303 | idx_tb1234567890123456789012345678_16471 |            | CREATE INDEX idx_tb1234567890123456789012345678_16471 ON tb1_20190303 USING btree (c1)
 public     | tb1_20190303 | idx_tb1_16471                            |            | CREATE INDEX idx_tb1_16471 ON tb1_20190303 USING btree (c1)
 public     | tb1_20190303 | pk_idx_tb1_16471                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16471 ON tb1_20190303 USING btree (c1)
 public     | tb1_20190304 | idx_tb1234567890123456789012345678_16474 |            | CREATE INDEX idx_tb1234567890123456789012345678_16474 ON tb1_20190304 USING btree (c1)
 public     | tb1_20190304 | idx_tb1_16474                            |            | CREATE INDEX idx_tb1_16474 ON tb1_20190304 USING btree (c1)
 public     | tb1_20190304 | pk_idx_tb1_16474                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16474 ON tb1_20190304 USING btree (c1)
 public     | tb1_20190305 | idx_tb1234567890123456789012345678_16477 |            | CREATE INDEX idx_tb1234567890123456789012345678_16477 ON tb1_20190305 USING btree (c1)
 public     | tb1_20190305 | idx_tb1_16477                            |            | CREATE INDEX idx_tb1_16477 ON tb1_20190305 USING btree (c1)
 public     | tb1_20190305 | pk_idx_tb1_16477                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16477 ON tb1_20190305 USING btree (c1)
 public     | tb1_20190306 | idx_tb1234567890123456789012345678_16480 |            | CREATE INDEX idx_tb1234567890123456789012345678_16480 ON tb1_20190306 USING btree (c1)
 public     | tb1_20190306 | idx_tb1_16480                            |            | CREATE INDEX idx_tb1_16480 ON tb1_20190306 USING btree (c1)
 public     | tb1_20190306 | pk_idx_tb1_16480                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16480 ON tb1_20190306 USING btree (c1)
 public     | tb1_20190307 | idx_tb1234567890123456789012345678_16483 |            | CREATE INDEX idx_tb1234567890123456789012345678_16483 ON tb1_20190307 USING btree (c1)
 public     | tb1_20190307 | idx_tb1_16483                            |            | CREATE INDEX idx_tb1_16483 ON tb1_20190307 USING btree (c1)
 public     | tb1_20190307 | pk_idx_tb1_16483                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16483 ON tb1_20190307 USING btree (c1)
 public     | tb1_20190308 | idx_tb1234567890123456789012345678_16486 |            | CREATE INDEX idx_tb1234567890123456789012345678_16486 ON tb1_20190308 USING btree (c1)
 public     | tb1_20190308 | idx_tb1_16486                            |            | CREATE INDEX idx_tb1_16486 ON tb1_20190308 USING btree (c1)
 public     | tb1_20190308 | pk_idx_tb1_16486                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16486 ON tb1_20190308 USING btree (c1)
 public     | tb1_20190309 | idx_tb1234567890123456789012345678_16489 |            | CREATE INDEX idx_tb1234567890123456789012345678_16489 ON tb1_20190309 USING btree (c1)
 public     | tb1_20190309 | idx_tb1_16489                            |            | CREATE INDEX idx_tb1_16489 ON tb1_20190309 USING btree (c1)
 public     | tb1_20190309 | pk_idx_tb1_16489                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16489 ON tb1_20190309 USING btree (c1)
 public     | tb1_20190310 | idx_tb1234567890123456789012345678_16492 |            | CREATE INDEX idx_tb1234567890123456789012345678_16492 ON tb1_20190310 USING btree (c1)
 public     | tb1_20190310 | idx_tb1_16492                            |            | CREATE INDEX idx_tb1_16492 ON tb1_20190310 USING btree (c1)
 public     | tb1_20190310 | pk_idx_tb1_16492                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16492 ON tb1_20190310 USING btree (c1)
(30 rows)

select * from rds.user_tab_part_indexes_def;
 tab_name |              idx_name              |             idx_sql              | is_pkey 
----------+------------------------------------+----------------------------------+---------
 tb1      | idx_tb1                            | create index    %i on   %t(c1)   | f
 tb1      | idx_tb1234567890123456789012345678 | create index %i on %t(c1)        | f
 tb1      | pk_idx_tb1                         | create unique index %i on %t(c1) | t
(3 rows)

select * from pg_constraint where conname like 'pk_idx_tb1%' order by conname;
     conname      | connamespace | contype | condeferrable | condeferred | convalidated | conrelid | contypid | conindid | confrelid | confupdtype | confdeltype | confmatchtype | conislocal | coninhcount | connoinherit | conkey | confkey | conpfeqop | conppeqop | conffeqop | conexclop | conbin | consrc 
------------------+--------------+---------+---------------+-------------+--------------+----------+----------+----------+-----------+-------------+-------------+---------------+------------+-------------+--------------+--------+---------+-----------+-----------+-----------+-----------+--------+--------
 pk_idx_tb1_16465 |         2200 | p       | f             | f           | t            |    16465 |        0 |    16515 |         0 |             |             |               | t          |           0 | t            | {1}    |         |           |           |           |           |        | 
 pk_idx_tb1_16468 |         2200 | p       | f             | f           | t            |    16468 |        0 |    16517 |         0 |             |             |               | t          |           0 | t            | {1}    |         |           |           |           |           |        | 
 pk_idx_tb1_16471 |         2200 | p       | f             | f           | t            |    16471 |        0 |    16519 |         0 |             |             |               | t          |           0 | t            | {1}    |         |           |           |           |           |        | 
 pk_idx_tb1_16474 |         2200 | p       | f             | f           | t            |    16474 |        0 |    16521 |         0 |             |             |               | t          |           0 | t            | {1}    |         |           |           |           |           |        | 
 pk_idx_tb1_16477 |         2200 | p       | f             | f           | t            |    16477 |        0 |    16523 |         0 |             |             |               | t          |           0 | t            | {1}    |         |           |           |           |           |        | 
 pk_idx_tb1_16480 |         2200 | p       | f             | f           | t            |    16480 |        0 |    16525 |         0 |             |             |               | t          |           0 | t            | {1}    |         |           |           |           |           |        | 
 pk_idx_tb1_16483 |         2200 | p       | f             | f           | t            |    16483 |        0 |    16527 |         0 |             |             |               | t          |           0 | t            | {1}    |         |           |           |           |           |        | 
 pk_idx_tb1_16486 |         2200 | p       | f             | f           | t            |    16486 |        0 |    16529 |         0 |             |             |               | t          |           0 | t            | {1}    |         |           |           |           |           |        | 
 pk_idx_tb1_16489 |         2200 | p       | f             | f           | t            |    16489 |        0 |    16531 |         0 |             |             |               | t          |           0 | t            | {1}    |         |           |           |           |           |        | 
 pk_idx_tb1_16492 |         2200 | p       | f             | f           | t            |    16492 |        0 |    16533 |         0 |             |             |               | t          |           0 | t            | {1}    |         |           |           |           |           |        | 
(10 rows)


-- 分区单独添加索引
create index idx_tb1_test on public.tb1_20190303(c1);
ERROR:  Creating an index directly on a table partition is not allowed, please invoke create_idx_on_parted_table to do this.
CONTEXT:  PL/pgSQL function rds.func_ddl_command_start() line 75 at RAISE

-- 验证索引
select * from pg_indexes where schemaname='public' and tablename like 'tb1%' order by tablename, indexname;
 schemaname |  tablename   |                indexname                 | tablespace |                                        indexdef                                        
------------+--------------+------------------------------------------+------------+----------------------------------------------------------------------------------------
 public     | tb1_20190301 | idx_tb1234567890123456789012345678_16465 |            | CREATE INDEX idx_tb1234567890123456789012345678_16465 ON tb1_20190301 USING btree (c1)
 public     | tb1_20190301 | idx_tb1_16465                            |            | CREATE INDEX idx_tb1_16465 ON tb1_20190301 USING btree (c1)
 public     | tb1_20190301 | pk_idx_tb1_16465                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16465 ON tb1_20190301 USING btree (c1)
 public     | tb1_20190302 | idx_tb1234567890123456789012345678_16468 |            | CREATE INDEX idx_tb1234567890123456789012345678_16468 ON tb1_20190302 USING btree (c1)
 public     | tb1_20190302 | idx_tb1_16468                            |            | CREATE INDEX idx_tb1_16468 ON tb1_20190302 USING btree (c1)
 public     | tb1_20190302 | pk_idx_tb1_16468                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16468 ON tb1_20190302 USING btree (c1)
 public     | tb1_20190303 | idx_tb1234567890123456789012345678_16471 |            | CREATE INDEX idx_tb1234567890123456789012345678_16471 ON tb1_20190303 USING btree (c1)
 public     | tb1_20190303 | idx_tb1_16471                            |            | CREATE INDEX idx_tb1_16471 ON tb1_20190303 USING btree (c1)
 public     | tb1_20190303 | pk_idx_tb1_16471                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16471 ON tb1_20190303 USING btree (c1)
 public     | tb1_20190304 | idx_tb1234567890123456789012345678_16474 |            | CREATE INDEX idx_tb1234567890123456789012345678_16474 ON tb1_20190304 USING btree (c1)
 public     | tb1_20190304 | idx_tb1_16474                            |            | CREATE INDEX idx_tb1_16474 ON tb1_20190304 USING btree (c1)
 public     | tb1_20190304 | pk_idx_tb1_16474                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16474 ON tb1_20190304 USING btree (c1)
 public     | tb1_20190305 | idx_tb1234567890123456789012345678_16477 |            | CREATE INDEX idx_tb1234567890123456789012345678_16477 ON tb1_20190305 USING btree (c1)
 public     | tb1_20190305 | idx_tb1_16477                            |            | CREATE INDEX idx_tb1_16477 ON tb1_20190305 USING btree (c1)
 public     | tb1_20190305 | pk_idx_tb1_16477                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16477 ON tb1_20190305 USING btree (c1)
 public     | tb1_20190306 | idx_tb1234567890123456789012345678_16480 |            | CREATE INDEX idx_tb1234567890123456789012345678_16480 ON tb1_20190306 USING btree (c1)
 public     | tb1_20190306 | idx_tb1_16480                            |            | CREATE INDEX idx_tb1_16480 ON tb1_20190306 USING btree (c1)
 public     | tb1_20190306 | pk_idx_tb1_16480                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16480 ON tb1_20190306 USING btree (c1)
 public     | tb1_20190307 | idx_tb1234567890123456789012345678_16483 |            | CREATE INDEX idx_tb1234567890123456789012345678_16483 ON tb1_20190307 USING btree (c1)
 public     | tb1_20190307 | idx_tb1_16483                            |            | CREATE INDEX idx_tb1_16483 ON tb1_20190307 USING btree (c1)
 public     | tb1_20190307 | pk_idx_tb1_16483                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16483 ON tb1_20190307 USING btree (c1)
 public     | tb1_20190308 | idx_tb1234567890123456789012345678_16486 |            | CREATE INDEX idx_tb1234567890123456789012345678_16486 ON tb1_20190308 USING btree (c1)
 public     | tb1_20190308 | idx_tb1_16486                            |            | CREATE INDEX idx_tb1_16486 ON tb1_20190308 USING btree (c1)
 public     | tb1_20190308 | pk_idx_tb1_16486                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16486 ON tb1_20190308 USING btree (c1)
 public     | tb1_20190309 | idx_tb1234567890123456789012345678_16489 |            | CREATE INDEX idx_tb1234567890123456789012345678_16489 ON tb1_20190309 USING btree (c1)
 public     | tb1_20190309 | idx_tb1_16489                            |            | CREATE INDEX idx_tb1_16489 ON tb1_20190309 USING btree (c1)
 public     | tb1_20190309 | pk_idx_tb1_16489                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16489 ON tb1_20190309 USING btree (c1)
 public     | tb1_20190310 | idx_tb1234567890123456789012345678_16492 |            | CREATE INDEX idx_tb1234567890123456789012345678_16492 ON tb1_20190310 USING btree (c1)
 public     | tb1_20190310 | idx_tb1_16492                            |            | CREATE INDEX idx_tb1_16492 ON tb1_20190310 USING btree (c1)
 public     | tb1_20190310 | pk_idx_tb1_16492                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16492 ON tb1_20190310 USING btree (c1)
(30 rows)

select * from rds.user_tab_part_indexes_def;
 tab_name |              idx_name              |             idx_sql              | is_pkey 
----------+------------------------------------+----------------------------------+---------
 tb1      | idx_tb1                            | create index    %i on   %t(c1)   | f
 tb1      | idx_tb1234567890123456789012345678 | create index %i on %t(c1)        | f
 tb1      | pk_idx_tb1                         | create unique index %i on %t(c1) | t
(3 rows)


-- 新增分区补建索引
select rds.add_range_partitions('public.tb1', '2019-03-11'::date, '1 day', 3);
ERROR:  type "create_idx_on_parted_table" does not exist
LINE 1: SELECT create_idx_on_parted_table 'alter table ' || l_part_n...
               ^
QUERY:  SELECT create_idx_on_parted_table 'alter table ' || l_part_name || ' add constraint ' || l_idx_name || ' primary key using index ' || l_idx_name
CONTEXT:  PL/pgSQL function rds.func_ddl_command_end() line 63 at assignment
SQL statement "create table tb1_20190311 partition of tb1 for values from ('20190311') to ('20190312')"
PL/pgSQL function rds.add_range_partitions(regclass,date,character varying,integer) line 38 at EXECUTE

-- 验证分区
select relname, relnamespace::regnamespace::text, pg_get_expr(relpartbound, oid, true) vals
  from pg_class
 where relnamespace::regnamespace::text='public' and relname like 'tb1%' and relispartition=true
 order by relname;
   relname    | relnamespace |                       vals                       
--------------+--------------+--------------------------------------------------
 tb1_20190301 | public       | FOR VALUES FROM ('03-01-2019') TO ('03-02-2019')
 tb1_20190302 | public       | FOR VALUES FROM ('03-02-2019') TO ('03-03-2019')
 tb1_20190303 | public       | FOR VALUES FROM ('03-03-2019') TO ('03-04-2019')
 tb1_20190304 | public       | FOR VALUES FROM ('03-04-2019') TO ('03-05-2019')
 tb1_20190305 | public       | FOR VALUES FROM ('03-05-2019') TO ('03-06-2019')
 tb1_20190306 | public       | FOR VALUES FROM ('03-06-2019') TO ('03-07-2019')
 tb1_20190307 | public       | FOR VALUES FROM ('03-07-2019') TO ('03-08-2019')
 tb1_20190308 | public       | FOR VALUES FROM ('03-08-2019') TO ('03-09-2019')
 tb1_20190309 | public       | FOR VALUES FROM ('03-09-2019') TO ('03-10-2019')
 tb1_20190310 | public       | FOR VALUES FROM ('03-10-2019') TO ('03-11-2019')
(10 rows)


-- 验证索引
select * from pg_indexes where schemaname='public' and tablename like 'tb1%' order by tablename, indexname;
 schemaname |  tablename   |                indexname                 | tablespace |                                        indexdef                                        
------------+--------------+------------------------------------------+------------+----------------------------------------------------------------------------------------
 public     | tb1_20190301 | idx_tb1234567890123456789012345678_16465 |            | CREATE INDEX idx_tb1234567890123456789012345678_16465 ON tb1_20190301 USING btree (c1)
 public     | tb1_20190301 | idx_tb1_16465                            |            | CREATE INDEX idx_tb1_16465 ON tb1_20190301 USING btree (c1)
 public     | tb1_20190301 | pk_idx_tb1_16465                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16465 ON tb1_20190301 USING btree (c1)
 public     | tb1_20190302 | idx_tb1234567890123456789012345678_16468 |            | CREATE INDEX idx_tb1234567890123456789012345678_16468 ON tb1_20190302 USING btree (c1)
 public     | tb1_20190302 | idx_tb1_16468                            |            | CREATE INDEX idx_tb1_16468 ON tb1_20190302 USING btree (c1)
 public     | tb1_20190302 | pk_idx_tb1_16468                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16468 ON tb1_20190302 USING btree (c1)
 public     | tb1_20190303 | idx_tb1234567890123456789012345678_16471 |            | CREATE INDEX idx_tb1234567890123456789012345678_16471 ON tb1_20190303 USING btree (c1)
 public     | tb1_20190303 | idx_tb1_16471                            |            | CREATE INDEX idx_tb1_16471 ON tb1_20190303 USING btree (c1)
 public     | tb1_20190303 | pk_idx_tb1_16471                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16471 ON tb1_20190303 USING btree (c1)
 public     | tb1_20190304 | idx_tb1234567890123456789012345678_16474 |            | CREATE INDEX idx_tb1234567890123456789012345678_16474 ON tb1_20190304 USING btree (c1)
 public     | tb1_20190304 | idx_tb1_16474                            |            | CREATE INDEX idx_tb1_16474 ON tb1_20190304 USING btree (c1)
 public     | tb1_20190304 | pk_idx_tb1_16474                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16474 ON tb1_20190304 USING btree (c1)
 public     | tb1_20190305 | idx_tb1234567890123456789012345678_16477 |            | CREATE INDEX idx_tb1234567890123456789012345678_16477 ON tb1_20190305 USING btree (c1)
 public     | tb1_20190305 | idx_tb1_16477                            |            | CREATE INDEX idx_tb1_16477 ON tb1_20190305 USING btree (c1)
 public     | tb1_20190305 | pk_idx_tb1_16477                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16477 ON tb1_20190305 USING btree (c1)
 public     | tb1_20190306 | idx_tb1234567890123456789012345678_16480 |            | CREATE INDEX idx_tb1234567890123456789012345678_16480 ON tb1_20190306 USING btree (c1)
 public     | tb1_20190306 | idx_tb1_16480                            |            | CREATE INDEX idx_tb1_16480 ON tb1_20190306 USING btree (c1)
 public     | tb1_20190306 | pk_idx_tb1_16480                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16480 ON tb1_20190306 USING btree (c1)
 public     | tb1_20190307 | idx_tb1234567890123456789012345678_16483 |            | CREATE INDEX idx_tb1234567890123456789012345678_16483 ON tb1_20190307 USING btree (c1)
 public     | tb1_20190307 | idx_tb1_16483                            |            | CREATE INDEX idx_tb1_16483 ON tb1_20190307 USING btree (c1)
 public     | tb1_20190307 | pk_idx_tb1_16483                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16483 ON tb1_20190307 USING btree (c1)
 public     | tb1_20190308 | idx_tb1234567890123456789012345678_16486 |            | CREATE INDEX idx_tb1234567890123456789012345678_16486 ON tb1_20190308 USING btree (c1)
 public     | tb1_20190308 | idx_tb1_16486                            |            | CREATE INDEX idx_tb1_16486 ON tb1_20190308 USING btree (c1)
 public     | tb1_20190308 | pk_idx_tb1_16486                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16486 ON tb1_20190308 USING btree (c1)
 public     | tb1_20190309 | idx_tb1234567890123456789012345678_16489 |            | CREATE INDEX idx_tb1234567890123456789012345678_16489 ON tb1_20190309 USING btree (c1)
 public     | tb1_20190309 | idx_tb1_16489                            |            | CREATE INDEX idx_tb1_16489 ON tb1_20190309 USING btree (c1)
 public     | tb1_20190309 | pk_idx_tb1_16489                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16489 ON tb1_20190309 USING btree (c1)
 public     | tb1_20190310 | idx_tb1234567890123456789012345678_16492 |            | CREATE INDEX idx_tb1234567890123456789012345678_16492 ON tb1_20190310 USING btree (c1)
 public     | tb1_20190310 | idx_tb1_16492                            |            | CREATE INDEX idx_tb1_16492 ON tb1_20190310 USING btree (c1)
 public     | tb1_20190310 | pk_idx_tb1_16492                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16492 ON tb1_20190310 USING btree (c1)
(30 rows)

select * from rds.user_tab_part_indexes_def;
 tab_name |              idx_name              |             idx_sql              | is_pkey 
----------+------------------------------------+----------------------------------+---------
 tb1      | idx_tb1                            | create index    %i on   %t(c1)   | f
 tb1      | idx_tb1234567890123456789012345678 | create index %i on %t(c1)        | f
 tb1      | pk_idx_tb1                         | create unique index %i on %t(c1) | t
(3 rows)


-- 分区单独删除索引
drop index idx_tb1_16486;
ERROR:  Dropping an index on a table partition directly is not allowed, please invoke drop_idx_on_parted_table to do this.
CONTEXT:  PL/pgSQL function rds.func_ddl_command_start() line 135 at RAISE

-- 验证索引
select * from pg_indexes where schemaname='public' and tablename like 'tb1%' order by tablename, indexname;
 schemaname |  tablename   |                indexname                 | tablespace |                                        indexdef                                        
------------+--------------+------------------------------------------+------------+----------------------------------------------------------------------------------------
 public     | tb1_20190301 | idx_tb1234567890123456789012345678_16465 |            | CREATE INDEX idx_tb1234567890123456789012345678_16465 ON tb1_20190301 USING btree (c1)
 public     | tb1_20190301 | idx_tb1_16465                            |            | CREATE INDEX idx_tb1_16465 ON tb1_20190301 USING btree (c1)
 public     | tb1_20190301 | pk_idx_tb1_16465                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16465 ON tb1_20190301 USING btree (c1)
 public     | tb1_20190302 | idx_tb1234567890123456789012345678_16468 |            | CREATE INDEX idx_tb1234567890123456789012345678_16468 ON tb1_20190302 USING btree (c1)
 public     | tb1_20190302 | idx_tb1_16468                            |            | CREATE INDEX idx_tb1_16468 ON tb1_20190302 USING btree (c1)
 public     | tb1_20190302 | pk_idx_tb1_16468                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16468 ON tb1_20190302 USING btree (c1)
 public     | tb1_20190303 | idx_tb1234567890123456789012345678_16471 |            | CREATE INDEX idx_tb1234567890123456789012345678_16471 ON tb1_20190303 USING btree (c1)
 public     | tb1_20190303 | idx_tb1_16471                            |            | CREATE INDEX idx_tb1_16471 ON tb1_20190303 USING btree (c1)
 public     | tb1_20190303 | pk_idx_tb1_16471                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16471 ON tb1_20190303 USING btree (c1)
 public     | tb1_20190304 | idx_tb1234567890123456789012345678_16474 |            | CREATE INDEX idx_tb1234567890123456789012345678_16474 ON tb1_20190304 USING btree (c1)
 public     | tb1_20190304 | idx_tb1_16474                            |            | CREATE INDEX idx_tb1_16474 ON tb1_20190304 USING btree (c1)
 public     | tb1_20190304 | pk_idx_tb1_16474                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16474 ON tb1_20190304 USING btree (c1)
 public     | tb1_20190305 | idx_tb1234567890123456789012345678_16477 |            | CREATE INDEX idx_tb1234567890123456789012345678_16477 ON tb1_20190305 USING btree (c1)
 public     | tb1_20190305 | idx_tb1_16477                            |            | CREATE INDEX idx_tb1_16477 ON tb1_20190305 USING btree (c1)
 public     | tb1_20190305 | pk_idx_tb1_16477                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16477 ON tb1_20190305 USING btree (c1)
 public     | tb1_20190306 | idx_tb1234567890123456789012345678_16480 |            | CREATE INDEX idx_tb1234567890123456789012345678_16480 ON tb1_20190306 USING btree (c1)
 public     | tb1_20190306 | idx_tb1_16480                            |            | CREATE INDEX idx_tb1_16480 ON tb1_20190306 USING btree (c1)
 public     | tb1_20190306 | pk_idx_tb1_16480                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16480 ON tb1_20190306 USING btree (c1)
 public     | tb1_20190307 | idx_tb1234567890123456789012345678_16483 |            | CREATE INDEX idx_tb1234567890123456789012345678_16483 ON tb1_20190307 USING btree (c1)
 public     | tb1_20190307 | idx_tb1_16483                            |            | CREATE INDEX idx_tb1_16483 ON tb1_20190307 USING btree (c1)
 public     | tb1_20190307 | pk_idx_tb1_16483                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16483 ON tb1_20190307 USING btree (c1)
 public     | tb1_20190308 | idx_tb1234567890123456789012345678_16486 |            | CREATE INDEX idx_tb1234567890123456789012345678_16486 ON tb1_20190308 USING btree (c1)
 public     | tb1_20190308 | idx_tb1_16486                            |            | CREATE INDEX idx_tb1_16486 ON tb1_20190308 USING btree (c1)
 public     | tb1_20190308 | pk_idx_tb1_16486                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16486 ON tb1_20190308 USING btree (c1)
 public     | tb1_20190309 | idx_tb1234567890123456789012345678_16489 |            | CREATE INDEX idx_tb1234567890123456789012345678_16489 ON tb1_20190309 USING btree (c1)
 public     | tb1_20190309 | idx_tb1_16489                            |            | CREATE INDEX idx_tb1_16489 ON tb1_20190309 USING btree (c1)
 public     | tb1_20190309 | pk_idx_tb1_16489                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16489 ON tb1_20190309 USING btree (c1)
 public     | tb1_20190310 | idx_tb1234567890123456789012345678_16492 |            | CREATE INDEX idx_tb1234567890123456789012345678_16492 ON tb1_20190310 USING btree (c1)
 public     | tb1_20190310 | idx_tb1_16492                            |            | CREATE INDEX idx_tb1_16492 ON tb1_20190310 USING btree (c1)
 public     | tb1_20190310 | pk_idx_tb1_16492                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16492 ON tb1_20190310 USING btree (c1)
(30 rows)

select * from rds.user_tab_part_indexes_def;
 tab_name |              idx_name              |             idx_sql              | is_pkey 
----------+------------------------------------+----------------------------------+---------
 tb1      | idx_tb1                            | create index    %i on   %t(c1)   | f
 tb1      | idx_tb1234567890123456789012345678 | create index %i on %t(c1)        | f
 tb1      | pk_idx_tb1                         | create unique index %i on %t(c1) | t
(3 rows)


-- 分区表删除索引
select rds.drop_idx_on_parted_table('public.tb1', 'idx_tb1');
 drop_idx_on_parted_table 
--------------------------
 
(1 row)


-- 验证索引
select * from pg_indexes where schemaname='public' and tablename like 'tb1%' order by tablename, indexname;
 schemaname |  tablename   |                indexname                 | tablespace |                                        indexdef                                        
------------+--------------+------------------------------------------+------------+----------------------------------------------------------------------------------------
 public     | tb1_20190301 | idx_tb1234567890123456789012345678_16465 |            | CREATE INDEX idx_tb1234567890123456789012345678_16465 ON tb1_20190301 USING btree (c1)
 public     | tb1_20190301 | pk_idx_tb1_16465                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16465 ON tb1_20190301 USING btree (c1)
 public     | tb1_20190302 | idx_tb1234567890123456789012345678_16468 |            | CREATE INDEX idx_tb1234567890123456789012345678_16468 ON tb1_20190302 USING btree (c1)
 public     | tb1_20190302 | pk_idx_tb1_16468                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16468 ON tb1_20190302 USING btree (c1)
 public     | tb1_20190303 | idx_tb1234567890123456789012345678_16471 |            | CREATE INDEX idx_tb1234567890123456789012345678_16471 ON tb1_20190303 USING btree (c1)
 public     | tb1_20190303 | pk_idx_tb1_16471                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16471 ON tb1_20190303 USING btree (c1)
 public     | tb1_20190304 | idx_tb1234567890123456789012345678_16474 |            | CREATE INDEX idx_tb1234567890123456789012345678_16474 ON tb1_20190304 USING btree (c1)
 public     | tb1_20190304 | pk_idx_tb1_16474                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16474 ON tb1_20190304 USING btree (c1)
 public     | tb1_20190305 | idx_tb1234567890123456789012345678_16477 |            | CREATE INDEX idx_tb1234567890123456789012345678_16477 ON tb1_20190305 USING btree (c1)
 public     | tb1_20190305 | pk_idx_tb1_16477                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16477 ON tb1_20190305 USING btree (c1)
 public     | tb1_20190306 | idx_tb1234567890123456789012345678_16480 |            | CREATE INDEX idx_tb1234567890123456789012345678_16480 ON tb1_20190306 USING btree (c1)
 public     | tb1_20190306 | pk_idx_tb1_16480                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16480 ON tb1_20190306 USING btree (c1)
 public     | tb1_20190307 | idx_tb1234567890123456789012345678_16483 |            | CREATE INDEX idx_tb1234567890123456789012345678_16483 ON tb1_20190307 USING btree (c1)
 public     | tb1_20190307 | pk_idx_tb1_16483                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16483 ON tb1_20190307 USING btree (c1)
 public     | tb1_20190308 | idx_tb1234567890123456789012345678_16486 |            | CREATE INDEX idx_tb1234567890123456789012345678_16486 ON tb1_20190308 USING btree (c1)
 public     | tb1_20190308 | pk_idx_tb1_16486                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16486 ON tb1_20190308 USING btree (c1)
 public     | tb1_20190309 | idx_tb1234567890123456789012345678_16489 |            | CREATE INDEX idx_tb1234567890123456789012345678_16489 ON tb1_20190309 USING btree (c1)
 public     | tb1_20190309 | pk_idx_tb1_16489                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16489 ON tb1_20190309 USING btree (c1)
 public     | tb1_20190310 | idx_tb1234567890123456789012345678_16492 |            | CREATE INDEX idx_tb1234567890123456789012345678_16492 ON tb1_20190310 USING btree (c1)
 public     | tb1_20190310 | pk_idx_tb1_16492                         |            | CREATE UNIQUE INDEX pk_idx_tb1_16492 ON tb1_20190310 USING btree (c1)
(20 rows)

select * from rds.user_tab_part_indexes_def;
 tab_name |              idx_name              |             idx_sql              | is_pkey 
----------+------------------------------------+----------------------------------+---------
 tb1      | idx_tb1234567890123456789012345678 | create index %i on %t(c1)        | f
 tb1      | pk_idx_tb1                         | create unique index %i on %t(c1) | t
(2 rows)


-- 批量truncate分区
select rds.truncate_range_partitions('public.tb1', '20190301', '20190302');
 truncate_range_partitions 
---------------------------
 
(1 row)


-- 验证数据
select * from public.tb1 order by c1;
 c1 |     c2     | c3 
----+------------+----
  3 | 03-03-2019 |  3
  4 | 03-04-2019 |  4
  5 | 03-05-2019 |  5
  6 | 03-06-2019 |  6
  7 | 03-07-2019 |  7
  8 | 03-08-2019 |  8
  9 | 03-09-2019 |  9
 10 | 03-10-2019 | 10
(8 rows)


-- ddl下推到分区
select relname, reloptions from pg_class where relname like 'tb1%' order by relname;
   relname    | reloptions 
--------------+------------
 tb1          | 
 tb1_20190301 | 
 tb1_20190302 | 
 tb1_20190303 | 
 tb1_20190304 | 
 tb1_20190305 | 
 tb1_20190306 | 
 tb1_20190307 | 
 tb1_20190308 | 
 tb1_20190309 | 
 tb1_20190310 | 
(11 rows)

select rds.run_command_on_parted_table('public.tb1', 'alter table %t set(fillfactor = 90)');
                 run_command_on_parted_table                  
--------------------------------------------------------------
 ("alter table tb1_20190303 set(fillfactor = 90)",success,"")
 ("alter table tb1_20190304 set(fillfactor = 90)",success,"")
 ("alter table tb1_20190305 set(fillfactor = 90)",success,"")
 ("alter table tb1_20190306 set(fillfactor = 90)",success,"")
 ("alter table tb1_20190307 set(fillfactor = 90)",success,"")
 ("alter table tb1_20190308 set(fillfactor = 90)",success,"")
 ("alter table tb1_20190309 set(fillfactor = 90)",success,"")
 ("alter table tb1_20190310 set(fillfactor = 90)",success,"")
 ("alter table tb1_20190302 set(fillfactor = 90)",success,"")
 ("alter table tb1_20190301 set(fillfactor = 90)",success,"")
(10 rows)

select relname, reloptions from pg_class where relname like 'tb1%' order by relname;
   relname    |   reloptions    
--------------+-----------------
 tb1          | 
 tb1_20190301 | {fillfactor=90}
 tb1_20190302 | {fillfactor=90}
 tb1_20190303 | {fillfactor=90}
 tb1_20190304 | {fillfactor=90}
 tb1_20190305 | {fillfactor=90}
 tb1_20190306 | {fillfactor=90}
 tb1_20190307 | {fillfactor=90}
 tb1_20190308 | {fillfactor=90}
 tb1_20190309 | {fillfactor=90}
 tb1_20190310 | {fillfactor=90}
(11 rows)


-- 批量删除分区
select rds.drop_range_partitions('public.tb1', '20190301', '20190302');
 drop_range_partitions 
-----------------------
 
(1 row)


-- 验证分区
select relname, relnamespace::regnamespace::text, pg_get_expr(relpartbound, oid, true) vals
  from pg_class
 where relnamespace::regnamespace::text='public' and relname like 'tb1%' and relispartition=true
 order by relname;
   relname    | relnamespace |                       vals                       
--------------+--------------+--------------------------------------------------
 tb1_20190303 | public       | FOR VALUES FROM ('03-03-2019') TO ('03-04-2019')
 tb1_20190304 | public       | FOR VALUES FROM ('03-04-2019') TO ('03-05-2019')
 tb1_20190305 | public       | FOR VALUES FROM ('03-05-2019') TO ('03-06-2019')
 tb1_20190306 | public       | FOR VALUES FROM ('03-06-2019') TO ('03-07-2019')
 tb1_20190307 | public       | FOR VALUES FROM ('03-07-2019') TO ('03-08-2019')
 tb1_20190308 | public       | FOR VALUES FROM ('03-08-2019') TO ('03-09-2019')
 tb1_20190309 | public       | FOR VALUES FROM ('03-09-2019') TO ('03-10-2019')
 tb1_20190310 | public       | FOR VALUES FROM ('03-10-2019') TO ('03-11-2019')
(8 rows)


-- ddl带双引号
create table "tb2"(c1 int, c2 date, c3 int) partition by range (c2);
ERROR:  DDL statement can not contain double quotes.
CONTEXT:  PL/pgSQL function rds.func_ddl_command_start() line 45 at RAISE

-- 删除分区表
drop table if exists tb1 cascade;
